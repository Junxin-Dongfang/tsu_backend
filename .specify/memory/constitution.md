<!--
同步影响报告:
版本变更: 1.0.0 → 1.1.0
修改的原则:
  - 所有原则从英文翻译为中文
新增章节:
  - 历史代码处理 (Note on Existing Code) - 定义了对现有代码的处理策略
移除章节: 无
模板状态:
  ✅ plan-template.md - 已审查,宪法检查章节保持一致
  ✅ spec-template.md - 已审查,需求标准保持一致
  ✅ tasks-template.md - 已审查,测试驱动工作流保持一致
后续待办事项: 无
-->

# TSU 游戏服务器项目宪法

## 核心原则

### 一、代码质量优先

**必须**在所有实现中保持高代码质量标准:
- 所有代码**必须**通过 `golangci-lint` 检查,不得有警告
- 所有代码**必须**遵循 Go 语言最佳实践和惯用模式
- 所有公共函数/方法**必须**包含完整的文档注释
- 所有错误处理**必须**显式且有意义(不允许静默失败)
- 所有数据库查询**必须**使用预编译语句或 ORM 方法(防止 SQL 注入)
- 代码**必须**通过清晰的命名约定实现自文档化

**理由**: 高质量代码可以减少技术债务、提高可维护性、增强安全性,并支持自信地重构。在游戏服务器环境中,可靠性和安全性至关重要,代码质量不容妥协。

### 二、测试驱动开发(不可协商)

**必须**遵循严格的测试驱动开发规范:
- 单元测试**必须**在实现代码**之前**编写
- 所有新功能**必须**包含关键路径的集成测试
- 所有 API 端点**必须**有验证请求/响应格式的契约测试
- 所有数据库操作**必须**有覆盖 CRUD 操作和边界情况的测试
- 测试**必须**达到业务逻辑至少 80% 的代码覆盖率
- **必须**严格执行红-绿-重构循环:编写失败测试 → 实现 → 重构

**理由**: 在包含多个服务(游戏服务器、认证、数据库)的分布式游戏服务器架构中,未经测试的代码会导致生产故障和级联系统问题。TDD 确保可靠性并支持安全的持续部署。

### 三、用户体验一致性

**必须**确保一致且可预测的用户体验:
- 所有 API 响应**必须**遵循标准化的 JSON 格式,具有一致的错误结构
- 所有错误消息**必须**清晰、可操作,并在适当时进行本地化
- 所有 API 端点**必须**包含正确的 HTTP 状态码(200、400、401、403、404、500 等)
- 所有面向用户的操作**必须**包含适当的验证并提供清晰的反馈
- 所有游戏机制**必须**在不同平台上保持一致的行为
- 所有响应时间**必须**可预测并在 API 契约中记录

**理由**: 玩家期望一致的行为和清晰的反馈。不一致的 API 和不可预测的响应会导致客户端集成的糟糕开发体验和沮丧的最终用户。

### 四、性能与资源效率

**必须**保持高性能和高效的资源利用:
- 所有 API 端点**必须**在正常负载下的 p95 延迟在 200ms 以内
- 所有数据库查询**必须**使用适当的索引进行优化,避免 N+1 查询
- 所有并发操作**必须**高效使用 goroutine(避免 goroutine 泄漏)
- 所有热路径中的内存分配**必须**最小化(适当使用 sync.Pool)
- 所有 Redis 操作**必须**对批量操作使用流水线
- 所有资源清理**必须**使用 defer 或适当的上下文取消

**理由**: 游戏服务器需要低延迟和高吞吐量来支持实时游戏。性能不佳会导致玩家沮丧、服务器成本增加和可扩展性限制。

### 五、可观测性与调试

**必须**实现全面的可观测性:
- 所有关键操作**必须**包含带有上下文的结构化日志(请求 ID、用户 ID 等)
- 所有错误**必须**记录完整的堆栈跟踪和上下文信息
- 所有 API 端点**必须**暴露 Prometheus 指标(请求计数、延迟、错误率)
- 所有数据库操作**必须**通过日志和指标可追踪
- 所有服务依赖(NATS、Redis、PostgreSQL)**必须**有健康检查
- 所有生产问题**必须**仅通过日志和指标即可诊断(无需手动调试)

**理由**: 在分布式微服务架构中,可观测性对于快速调试、性能分析和主动问题检测至关重要。没有适当的日志和指标,生产问题将无法诊断。

## 性能与可扩展性标准

### 响应时间要求

- **API 端点**: p95 延迟 <200ms,p99 延迟 <500ms
- **数据库查询**: 简单查询 <50ms,复杂连接 <200ms
- **Redis 操作**: 缓存读取 <10ms,缓存写入 <20ms
- **消息队列**: NATS 发布操作 <100ms

### 可扩展性目标

- **并发用户**: 系统**必须**支持每个服务器实例 10,000 个并发玩家
- **请求吞吐量**: 每个 API 服务器至少 1,000 请求/秒
- **数据库连接**: 连接池大小**必须**根据预期负载调优(默认:25 个连接)
- **水平扩展**: 所有服务**必须**是无状态的并支持水平扩展

### 资源约束

- **内存使用**: 单个服务在正常负载下**不得**超过 512MB
- **CPU 使用**: 服务在正常负载下**必须**保持 CPU 利用率 <70%
- **数据库存储**: **必须**实施数据保留策略和归档策略
- **日志量**: **必须**限制日志详细程度以防止磁盘空间耗尽

## 开发工作流与质量关卡

### 代码审查要求

- **所有**代码更改**必须**由至少一名团队成员审查
- **所有**拉取请求**必须**通过 CI 检查(测试、代码检查、构建)
- **所有**破坏性 API 更改**必须**记录并由技术负责人批准
- **所有**数据库架构更改**必须**包含迁移脚本和回滚计划

### 测试关卡

- **提交前**: golangci-lint **必须**在本地通过
- **CI 流水线**: 所有单元测试、集成测试和契约测试**必须**通过
- **部署前**: 负载测试**必须**验证性能要求
- **部署后**: 健康检查**必须**确认服务可用性

### 文档要求

- **API 端点**: **必须**使用 Swagger/OpenAPI 规范记录
- **数据库架构**: **必须**包含实体关系图和迁移文档
- **配置**: **必须**记录所有环境变量和配置选项
- **部署**: **必须**维护最新的部署手册和回滚程序

### 版本控制标准

- **提交消息**: **必须**遵循约定式提交格式(feat:、fix:、docs:、refactor:、test:)
- **分支命名**: **必须**使用格式:feature/xxx、bugfix/xxx、hotfix/xxx
- **语义化版本**: **必须**遵循 MAJOR.MINOR.PATCH 格式进行发布
- **破坏性变更**: **必须**增加 MAJOR 版本并提供迁移指南

## 历史代码处理

本《宪法》自 **2025-10-21** 起正式生效。其所有原则和标准,**严格适用于此日期之后所有新增或大规模重构的功能代码**。

对于在此日期之前已经存在的历史代码,我们承认其可能不完全符合本《宪法》的所有条款。处理这些历史代码的原则如下:

### 不主动进行大规模重构

除非有明确的业务需求或严重的性能/安全问题,我们**不**专门为"符合宪法"而开启对旧代码的重构项目。

**理由**: 大规模重构风险高、成本大,且可能引入新的 bug。在没有明确业务价值的情况下,保持系统稳定性优先。

### "童子军军规"原则 (The Boy Scout Rule)

在修改旧代码以修复 Bug 或添加小功能时,**应**顺手将其整理得比原来更干净一点。例如:
- 改善命名,使其更符合项目约定
- 添加缺失的注释或文档
- 补充单元测试(特别是针对修改的部分)
- 修复明显的代码异味(code smells)
- 提取重复代码为可复用函数
- 具体的改进指南参照[TECH_DEBT.md](../../TECH_DEBT.md)，清理过后需要对审计报告进行版本更新，直到该审计报告的问题都解决。

**理由**: 逐步改进比一次性重构更安全、更可持续。每次触及代码时都让其变得更好,随着时间推移代码质量会自然提升。

### 新旧隔离

所有与旧代码交互的新模块,其自身**必须**严格遵守《宪法》。具体要求:
- 新模块的内部实现**必须**完全符合所有宪法原则
- 新模块**必须**有完整的测试覆盖(≥80%)
- 新模块**必须**有清晰的文档
- 与旧代码的交互边界**必须**明确定义并文档化
- 新模块**不得**因适配旧代码而降低自身质量标准

**理由**: 确保新代码不会因历史包袱而降低质量,同时为未来逐步替换旧代码创造条件。新模块作为高质量代码的示范,引导整体代码库向更好的方向演进。

## 治理

### 修订流程

- 宪法修订**必须**通过拉取请求提交到 `.specify/memory/constitution.md`
- 所有修订**必须**包含理由和影响分析
- 主要版本变更需要所有核心团队成员批准
- 次要/补丁版本变更需要技术负责人批准

### 合规验证

- 所有拉取请求**必须**根据宪法原则进行审查
- 违规行为**必须**以书面形式证明有令人信服的业务理由
- 批准的违规行为**必须**作为技术债务跟踪,并附有修复计划
- 季度审查**必须**评估整体合规性并确定改进领域

### 强制执行

- CI 流水线**必须**强制执行自动化检查(代码检查、测试、覆盖率)
- 代码审查清单**必须**包含宪法合规性验证
- 由宪法违规引起的生产事故**必须**触发事后回顾
- 重复违规**必须**通过团队培训和流程改进来解决

### 活文档

- 宪法**必须**每季度审查其相关性和有效性
- 开发过程中的反馈**必须**为宪法更新提供依据
- 所有开发人员**必须**在入职期间确认并理解宪法
- 宪法版本控制**必须**遵循语义化版本控制进行治理变更

**版本**: 1.1.0 | **批准日期**: 2025-10-21 | **最后修订**: 2025-10-21
