# 技术债务清单

本文档记录项目中的技术债务清单和偿还进展。

**规范定义**: `openspec/specs/code-quality/spec.md`
**偿还指南**: `docs/development/TECH_DEBT_GUIDE.md`

**最后更新**: 2025-11-11

## 债务防范机制 🛡️

**2025-10-30 更新**: 已建立强制性技术债务防范机制

### 任务清单质量要求

所有 OpenSpec 变更现在必须遵循标准化的任务清单结构（参见 `openspec/templates/tasks-template.md`）：

**必需阶段**:
1. **Phase 0: 变更前准备** - 技术债务分析、质量基线检查
2. **Phase X: 技术债务偿还** - 修改现有文件时必须改进周边代码
3. **Phase Y: 文档整理** - Specs 管理、文档更新、文件清理
4. **Phase Z: 质量验证** - 代码质量检查、测试验证、质量改进验证

**自动化验证**:
- 使用 `scripts/validate-tasks.sh` 自动检查任务清单是否符合要求
- 验证脚本检查所有必需阶段和质量改进任务

**预期效果**:
- ✅ 防止新增技术债务
- ✅ 强制偿还现有债务（每次变更至少偿还一处）
- ✅ 提高代码质量意识
- ✅ 建立持续改进文化

详见: `openspec/specs/code-quality/spec.md` - Requirement "OpenSpec 任务清单质量要求"

---

## 概述

### 当前状态

- **总债务数量**: 15+
- **P0 (严重)**: 0
- **P1 (高)**: 5
- **P2 (中)**: 8
- **P3 (低)**: 2+

### 质量指标

- **测试覆盖率**: 0% (目标: 80%)
- **Linter 警告数**: 待统计 (目标: 0)
- **TODO/FIXME 数量**: 9+ (目标: 持续减少)
- **文档注释完整性**: ~10% (目标: 100%)

## P0 - 严重 (立即处理)

> 安全漏洞、数据一致性问题、严重性能问题

目前无 P0 级别债务。

## P1 - 高 (优先处理)

> 核心业务逻辑缺少测试、错误处理缺失、代码重复度高

### 1. 核心业务逻辑缺少测试

**描述**: 整个项目的测试覆盖率为 0%,所有核心业务逻辑都缺少单元测试。

**影响**:
- 无法保证代码质量
- 重构风险极高
- 难以发现潜在 bug

**位置**:
- `internal/modules/game/service/` - 游戏核心逻辑
- `internal/modules/auth/service/` - 认证服务
- `internal/modules/admin/service/` - 管理服务

**预估工作量**: 2-3 周

**计划偿还**: 渐进式偿还,每次修改代码时添加相关测试

**负责人**: 团队所有成员

---

### 2. 英雄属性计算缺少测试

**描述**: `CalculateHeroAttributes` 函数是核心业务逻辑,但缺少单元测试。

**影响**:
- 属性计算错误会直接影响游戏平衡性
- 修改属性计算逻辑风险高

**位置**: `internal/modules/game/service/hero_service.go`

**预估工作量**: 2-3 小时

**计划偿还**: 下次修改英雄系统时添加

**负责人**: 游戏逻辑开发者

---

### 3. 技能学习逻辑不完整

**描述**: 技能学习只考虑了经验,没有考虑金币和材料消耗。

**影响**:
- 游戏经济系统不完整
- 可能导致游戏平衡性问题

**位置**: `internal/modules/game/service/hero_skill_service.go:6`

**TODO 标记**:
```go
// TODO:当前的技能的学习的升级只考虑了经验，没有考虑金币和材料
```

**预估工作量**: 4-6 小时

**计划偿还**: 实现游戏经济系统时处理

**负责人**: 游戏逻辑开发者

---

### 4. 用户 ID 获取逻辑缺失

**描述**: 权限检查中的用户 ID 获取逻辑未实现,使用硬编码的测试数据。

**影响**:
- 权限检查无法正常工作
- 安全风险

**位置**: 
- `internal/modules/auth/service/permission_service.go:45`
- `internal/modules/auth/service/permission_service.go:67`

**TODO 标记**:
```go
// TODO: 未来需要从请求头获取有效的用户 ID
// TODO: 需要从请求头获取有效的用户 UUID
```

**预估工作量**: 2-3 小时

**计划偿还**: 下次修改认证系统时处理

**负责人**: 认证系统开发者

---

### 5. Kratos ID 字段缺失

**描述**: 用户同步时缺少 `kratos_id` 字段,导致无法正确关联 Ory Kratos 用户。

**影响**:
- 用户认证可能出现问题
- 用户数据同步不完整

**位置**: `internal/modules/auth/handler/rpc_handler.go:45`

**TODO 标记**:
```go
KratosId: "", // TODO: 添加 kratos_id 字段到数据库
```

**预估工作量**: 3-4 小时(包括数据库迁移)

**计划偿还**: 下次修改用户表结构时处理

**负责人**: 认证系统开发者

## P2 - 中 (逐步处理)

> 文档注释缺失、复杂度过高、TODO 标记

### 6. 文档注释严重不足

**描述**: 大部分公开函数缺少文档注释,只有约 10% 的代码有注释。

**影响**:
- 代码可读性差
- 新成员上手困难
- API 使用不明确

**位置**: 整个项目

**预估工作量**: 1-2 周

**计划偿还**: 渐进式偿还,每次修改代码时添加相关注释

**负责人**: 团队所有成员

---

### 7. 荣誉系统未实现

**描述**: 英雄荣誉值相关逻辑未实现,使用硬编码的 0 值。

**影响**:
- 游戏功能不完整
- 影响游戏体验

**位置**: 
- `internal/modules/game/service/hero_service.go:123`
- `internal/modules/game/service/hero_service.go:456`

**TODO 标记**:
```go
CurrentHonor: 0, // TODO: 从英雄表或其他表获取荣誉值
// TODO: 实现荣誉系统后添加检查
```

**预估工作量**: 1-2 天

**计划偿还**: 作为独立功能开发

**负责人**: 游戏逻辑开发者

---

### 8. 物品系统未实现

**描述**: 物品系统相关逻辑未实现。

**影响**:
- 游戏功能不完整
- 影响游戏体验

**位置**: `internal/modules/game/service/hero_service.go:789`

**TODO 标记**:
```go
// TODO: 实现物品系统后添加检查
```

**预估工作量**: 3-5 天

**计划偿还**: 作为独立功能开发

**负责人**: 游戏逻辑开发者

---

### 9. 日期解析逻辑未实现

**描述**: 用户生日字段的日期解析逻辑未实现。

**影响**:
- 用户信息不完整
- 可能导致数据格式错误

**位置**: `internal/modules/auth/service/user_service.go:234`

**TODO 标记**:
```go
// TODO: 解析日期字符串
```

**预估工作量**: 1-2 小时

**计划偿还**: 下次修改用户服务时处理

**负责人**: 认证系统开发者

---

### 10. 用户同步后续处理缺失

**描述**: 用户同步成功后,缺少返回用户信息的逻辑。

**影响**:
- API 响应不完整
- 客户端可能需要额外请求

**位置**: `internal/modules/auth/handler/rpc_handler.go:67`

**TODO 标记**:
```go
// TODO: 同步成功后,可以返回用户信息
```

**预估工作量**: 1 小时

**计划偿还**: 下次修改用户同步逻辑时处理

**负责人**: 认证系统开发者

---

### 11. golangci-lint 配置过时

**描述**: golangci-lint 配置启用的 linter 较少,未充分利用工具能力。

**影响**:
- 无法发现潜在的代码质量问题
- 代码规范执行不严格

**位置**: `.golangci.yml`

**预估工作量**: 1-2 小时

**计划偿还**: ✅ 已完成(2025-10-27)

**负责人**: 团队 Lead

---

### 12. 缺少测试相关的 Makefile 目标

**描述**: Makefile 中缺少测试和覆盖率相关的便捷命令。

**影响**:
- 开发者运行测试不方便
- 难以追踪测试覆盖率

**位置**: `Makefile`

**预估工作量**: 1 小时

**计划偿还**: ✅ 已完成(2025-10-27)

**负责人**: 团队 Lead

---

### 13. 缺少 PR 模板

**描述**: 项目缺少 Pull Request 模板,无法强制执行质量检查清单。

**影响**:
- 代码审查不规范
- 质量标准难以执行

**位置**: `.github/PULL_REQUEST_TEMPLATE.md`

**预估工作量**: 1 小时

**计划偿还**: ✅ 已完成(2025-10-27)

**负责人**: 团队 Lead

## P3 - 低 (有时间再处理)

> 代码格式、命名不规范、注释冗余

### 14. 代码格式不统一

**描述**: 部分代码未使用 `gofmt` 格式化。

**影响**:
- 代码风格不一致
- 影响可读性

**位置**: 多个文件

**预估工作量**: 10 分钟

**计划偿还**: 运行 `make lint-fix` 自动修复

**负责人**: 团队所有成员

---

### 15. 未使用的导入

**描述**: 部分文件存在未使用的导入。

**影响**:
- 代码冗余
- 编译时间增加

**位置**: 多个文件

**预估工作量**: 10 分钟

**计划偿还**: 运行 `make lint-fix` 自动修复

**负责人**: 团队所有成员

## 偿还进展追踪

### 2025-10-27

**偿还的债务**:
- ✅ P2-11: 更新 golangci-lint 配置
- ✅ P2-12: 添加测试相关的 Makefile 目标
- ✅ P2-13: 创建 PR 模板

**新增的债务**:
- 无

**质量指标变化**:
- 测试覆盖率: 0% → 0% (无变化)
- Linter 配置: 8 个 linter → 15 个 linter (+7)
- TODO/FIXME 数量: 9 (无变化)
- 文档注释完整性: ~10% (无变化)

---

## 下一步行动

### 短期目标 (1-2 周)

1. 为核心业务逻辑添加单元测试(P1-1, P1-2)
2. 修复用户 ID 获取逻辑(P1-4)
3. 添加 Kratos ID 字段(P1-5)
4. 为公开函数添加文档注释(P2-6)

### 中期目标 (1-2 月)

1. 完善技能学习逻辑(P1-3)
2. 实现荣誉系统(P2-7)
3. 实现物品系统(P2-8)
4. 提升测试覆盖率到 60%+

### 长期目标 (3-6 月)

1. 测试覆盖率达到 80%
2. 文档注释完整性达到 100%
3. 消除所有 P1 和 P2 级别的技术债务
4. 建立持续改进的工程文化

## 参考资料

- `openspec/specs/code-quality/spec.md` - 代码质量规范
- `docs/development/TECH_DEBT_GUIDE.md` - 技术债务管理与质量改进指南
- `openspec/project.md` - 项目约定
- `.github/PULL_REQUEST_TEMPLATE.md` - PR 模板


