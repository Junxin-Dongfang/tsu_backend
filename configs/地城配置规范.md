# 地城配置规范

## 概述

地城（副本）系统是游戏的核心 PVE 内容,提供可重复游玩的挑战关卡。本文档详细说明地城配置的数据结构和使用方法。

---

## 配置表结构

### 1. 地城配置表 (dungeons)

存储地城的基础信息和房间序列。

#### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | UUID | 是 | 地城唯一标识符 |
| dungeon_code | VARCHAR(50) | 是 | 地城代码,全局唯一 |
| dungeon_name | VARCHAR(100) | 是 | 地城名称 |
| min_level | SMALLINT | 是 | 最小等级要求 |
| max_level | SMALLINT | 是 | 最大等级要求 |
| description | TEXT | 否 | 地城描述 |
| is_time_limited | BOOLEAN | 是 | 是否限时开放 |
| time_limit_start | TIMESTAMPTZ | 否 | 限时开始时间 |
| time_limit_end | TIMESTAMPTZ | 否 | 限时结束时间 |
| requires_attempts | BOOLEAN | 是 | 是否限制挑战次数 |
| max_attempts_per_day | SMALLINT | 否 | 每日最大挑战次数 |
| room_sequence | JSONB | 是 | 房间序列配置 |
| is_active | BOOLEAN | 是 | 是否启用 |

#### room_sequence JSONB 格式

```json
[
  {
    "room_id": "房间代码",
    "sort": 1,
    "conditional_skip": {
      "condition": "条件类型",
      "target_room": "目标房间ID"
    },
    "conditional_return": {
      "condition": "条件类型",
      "target_room": "目标房间ID"
    }
  }
]
```

#### 配置示例

```json
{
  "dungeon_code": "DUNGEON_001",
  "dungeon_name": "缇丝娜诺-矿脉调查",
  "min_level": 1,
  "max_level": 5,
  "description": "阿克瑞斯旁边的杂铁山脉有不少的矿道正在开发...",
  "is_time_limited": false,
  "requires_attempts": false,
  "room_sequence": [
    {
      "room_id": "DUNGEON_001_ROOM01",
      "sort": 1
    },
    {
      "room_id": "DUNGEON_001_ROOM02",
      "sort": 2
    }
  ],
  "is_active": true
}
```

---

### 2. 房间配置表 (dungeon_rooms)

存储房间的类型和触发配置。

#### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | UUID | 是 | 房间唯一标识符 |
| room_code | VARCHAR(50) | 是 | 房间代码,全局唯一 |
| room_name | VARCHAR(100) | 否 | 房间名称 |
| room_type | VARCHAR(20) | 是 | 房间类型: battle/event/treasure/rest |
| trigger_id | VARCHAR(50) | 否 | 触发ID(战斗ID或事件ID) |
| open_conditions | JSONB | 是 | 开启条件 |
| is_active | BOOLEAN | 是 | 是否启用 |

#### open_conditions JSONB 格式

```json
{
  "match_item": ["物品代码1", "物品代码2"],
  "match_trait": ["特质代码1"]
}
```

#### 配置示例

```json
{
  "room_code": "DUNGEON_001_ROOM01",
  "room_name": "前往阿克瑞斯",
  "room_type": "battle",
  "trigger_id": "BATTLE_001",
  "open_conditions": {},
  "is_active": true
}
```

---

### 3. 战斗配置表 (dungeon_battles)

存储战斗场景的详细配置。

#### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | UUID | 是 | 战斗配置唯一标识符 |
| battle_code | VARCHAR(50) | 是 | 战斗代码,全局唯一 |
| location_config | JSONB | 是 | 场地配置 |
| global_buffs | JSONB | 是 | 全程状态 |
| monster_setup | JSONB | 是 | 怪物配置 |
| battle_start_desc | TEXT | 否 | 战斗开始描述 |
| battle_success_desc | TEXT | 否 | 战斗成功描述 |
| battle_failure_desc | TEXT | 否 | 战斗失败描述 |
| is_active | BOOLEAN | 是 | 是否启用 |

#### location_config JSONB 格式

```json
{
  "location": "场地类型",
  "location_events": ["场地事件1", "场地事件2"]
}
```

#### global_buffs JSONB 格式

```json
[
  {
    "buff_code": "BUFF代码",
    "target": "all_heroes"
  }
]
```

#### monster_setup JSONB 格式

```json
[
  {
    "monster_code": "怪物代码",
    "position": 14,
    "level_override": null
  }
]
```

**位置说明**: 位置值范围 1-21,对应战场格子位置。

#### 配置示例

```json
{
  "battle_code": "BATTLE_001",
  "location_config": {
    "location": "mountain_path",
    "location_events": []
  },
  "global_buffs": [],
  "monster_setup": [
    {
      "monster_code": "MAD_DOG",
      "position": 14
    },
    {
      "monster_code": "MAD_DOG",
      "position": 15
    }
  ],
  "battle_start_desc": "杂铁山脉，真是奇怪的名字...",
  "is_active": true
}
```

---

### 4. 事件配置表 (dungeon_events)

存储事件的效果和奖励配置。

#### 字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | UUID | 是 | 事件配置唯一标识符 |
| event_code | VARCHAR(50) | 是 | 事件代码,全局唯一 |
| event_description | TEXT | 否 | 事件描述 |
| apply_effects | JSONB | 是 | 施加效果 |
| drop_config | JSONB | 是 | 掉落配置 |
| reward_exp | INT | 是 | 经验奖励 |
| event_end_desc | TEXT | 否 | 事件结束描述 |
| is_active | BOOLEAN | 是 | 是否启用 |

#### apply_effects JSONB 格式

```json
[
  {
    "buff_code": "BUFF代码",
    "buff_params": {
      "duration": 300,
      "strength_bonus": 10
    },
    "caster_level": 5,
    "target": "all_heroes"
  }
]
```

#### drop_config JSONB 格式

```json
{
  "drop_pool_id": "掉落池UUID",
  "guaranteed_items": [
    {
      "item_code": "物品代码",
      "quantity": 1
    }
  ]
}
```

#### 配置示例

```json
{
  "event_code": "EVENT_001",
  "event_description": "你发现了一个神秘的宝箱",
  "apply_effects": [],
  "drop_config": {
    "drop_pool_id": "550e8400-e29b-41d4-a716-446655440001",
    "guaranteed_items": [
      {
        "item_code": "HEALTH_POTION",
        "quantity": 3
      }
    ]
  },
  "reward_exp": 500,
  "event_end_desc": "你打开了宝箱，获得了一些有用的物品",
  "is_active": true
}
```

---

## 配置流程

### 1. 创建房间

首先创建地城需要的所有房间:

```bash
POST /api/v1/admin/dungeon-rooms
```

### 2. 创建战斗配置

为战斗类型的房间创建战斗配置:

```bash
POST /api/v1/admin/dungeon-battles
```

### 3. 创建事件配置

为事件类型的房间创建事件配置:

```bash
POST /api/v1/admin/dungeon-events
```

### 4. 创建地城

最后创建地城,引用已创建的房间:

```bash
POST /api/v1/admin/dungeons
```

---

## 验证规则

### 地城配置验证

1. **代码唯一性**: `dungeon_code` 必须全局唯一
2. **等级区间**: `min_level` ≤ `max_level`
3. **限时配置**: 如果 `is_time_limited=true`,必须设置开始和结束时间
4. **挑战次数**: 如果 `requires_attempts=true`,必须设置 `max_attempts_per_day > 0`
5. **房间序列**: 至少包含一个房间,所有房间必须存在

### 房间配置验证

1. **代码唯一性**: `room_code` 必须全局唯一
2. **房间类型**: 必须是 `battle`、`event`、`treasure`、`rest` 之一
3. **触发ID**: 战斗房间应关联战斗配置,事件房间应关联事件配置

### 战斗配置验证

1. **代码唯一性**: `battle_code` 必须全局唯一
2. **怪物存在性**: 所有 `monster_code` 必须在怪物表中存在
3. **位置合法性**: 位置值必须在 1-21 之间
4. **位置唯一性**: 同一战斗中不能有重复的位置

### 事件配置验证

1. **代码唯一性**: `event_code` 必须全局唯一
2. **经验值**: `reward_exp` 必须 ≥ 0
3. **掉落池**: 如果配置了 `drop_pool_id`,必须在掉落池表中存在
4. **物品**: 如果配置了保底物品,物品代码必须存在

---

## 注意事项

1. **软删除**: 所有配置支持软删除,删除后 `deleted_at` 字段会被设置
2. **JSONB 格式**: 所有 JSONB 字段必须是有效的 JSON 格式
3. **外键约束**: 删除被引用的配置会失败
4. **缓存**: 配置更新后可能需要刷新缓存
5. **测试**: 配置完成后建议在测试环境验证

---

## API 文档

完整的 API 文档请访问: `/swagger/index.html`

相关接口:
- 地城管理: `/api/v1/admin/dungeons`
- 房间管理: `/api/v1/admin/dungeon-rooms`
- 战斗配置: `/api/v1/admin/dungeon-battles`
- 事件配置: `/api/v1/admin/dungeon-events`

