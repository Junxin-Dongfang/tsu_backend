# 怪物配置规范

本文档说明怪物配置的 JSON 格式规范和导入工具的使用方法。

---

## 📋 目录

1. [JSON 配置格式](#json-配置格式)
2. [字段说明](#字段说明)
3. [导入工具使用](#导入工具使用)
4. [配置示例](#配置示例)
5. [常见问题](#常见问题)

---

## JSON 配置格式

### 基本结构

怪物配置文件是一个 JSON 数组，每个元素代表一个怪物：

```json
[
  {
    "monster_code": "MAD_DOG",
    "monster_name": "疯狗",
    "monster_level": 2,
    ...
  },
  {
    "monster_code": "GOBLIN_SOLDIER",
    "monster_name": "哥布林刀盾手",
    "monster_level": 3,
    ...
  }
]
```

### 完整字段列表

```json
{
  // ========== 基础信息 ==========
  "monster_code": "MAD_DOG",           // 必填，怪物代码，唯一标识
  "monster_name": "疯狗",              // 必填，怪物名称
  "monster_level": 2,                  // 必填，怪物等级 (1-100)
  "description": "一只失去理智的野狗", // 可选，怪物描述
  
  // ========== 生命与法力 ==========
  "max_hp": 20,                        // 必填，最大生命值 (>0)
  "hp_recovery": 2,                    // 可选，生命恢复，默认 0
  "max_mp": 0,                         // 可选，最大法力值，默认 0
  "mp_recovery": 0,                    // 可选，法力恢复，默认 0
  
  // ========== 基础属性 (0-99) ==========
  "base_str": 1,                       // 可选，力量，默认 0
  "base_agi": 3,                       // 可选，敏捷，默认 0
  "base_vit": 1,                       // 可选，体质，默认 0
  "base_wlp": 0,                       // 可选，意志，默认 0
  "base_int": 1,                       // 可选，智力，默认 0
  "base_wis": 0,                       // 可选，感知，默认 0
  "base_cha": 0,                       // 可选，魅力，默认 0
  
  // ========== 战斗属性类型代码 ==========
  "accuracy_attribute_code": "ACCURACY",              // 可选，精准属性类型代码，默认 "ACCURACY"
  "dodge_attribute_code": "DODGE",                    // 可选，闪避属性类型代码，默认 "DODGE"
  "initiative_attribute_code": "INITIATIVE",          // 可选，先攻属性类型代码，默认 "INITIATIVE"
  "body_resist_attribute_code": "BODY_RESIST",        // 可选，体质豁免属性类型代码，默认 "BODY_RESIST"
  "magic_resist_attribute_code": "MAGIC_RESIST",      // 可选，魔法豁免属性类型代码，默认 "MAGIC_RESIST"
  "mental_resist_attribute_code": "MENTAL_RESIST",    // 可选，精神豁免属性类型代码，默认 "MENTAL_RESIST"
  "environment_resist_attribute_code": "ENVIRONMENT_RESIST", // 可选，环境豁免属性类型代码，默认 "ENVIRONMENT_RESIST"
  
  // ========== JSON 配置 ==========
  "damage_resistances": {              // 可选，伤害抗性
    "SHADOW_DR": 1,                    // 暗影伤害减免 1 点
    "FIRE_RESIST": 0.5                 // 火焰伤害减半
  },
  "passive_buffs": [],                 // 可选，被动 Buff 列表
  
  // ========== 掉落配置 ==========
  "drop_gold_min": 10,                 // 可选，最小掉落金币，默认 0
  "drop_gold_max": 30,                 // 可选，最大掉落金币，默认 0
  "drop_exp": 20,                      // 可选，掉落经验值，默认 0
  
  // ========== 显示配置 ==========
  "icon_url": "/assets/monsters/mad_dog.png",   // 可选，图标 URL
  "model_url": "/assets/models/mad_dog.fbx",    // 可选，模型 URL
  "is_active": true,                             // 可选，是否启用，默认 true
  "display_order": 0,                            // 可选，显示顺序，默认 0
  
  // ========== 关联配置 ==========
  "skills": [                          // 可选，技能列表
    {
      "skill_code": "BITE",            // 必填，技能代码
      "skill_level": 2,                // 必填，技能等级 (1-20)
      "gain_actions": ["MAD_DOG_BITE"] // 可选，获得的动作列表
    }
  ],
  
  "drops": [                           // 可选，掉落列表
    {
      "drop_pool_code": "COMMON_LOOT", // 必填，掉落池代码
      "drop_type": "team",             // 必填，掉落类型 (team/personal)
      "drop_chance": 0.8,              // 必填，掉落概率 (0-1)
      "min_quantity": 1,               // 必填，最小数量 (>=1)
      "max_quantity": 3                // 必填，最大数量 (>=min_quantity)
    }
  ],
  
  "tags": ["Beast", "Melee", "Common"] // 可选，标签列表
}
```

---

## 字段说明

### 必填字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| monster_code | string | 怪物代码，唯一标识 | "MAD_DOG" |
| monster_name | string | 怪物名称 | "疯狗" |
| monster_level | integer | 怪物等级 (1-100) | 2 |
| max_hp | integer | 最大生命值 (>0) | 20 |

### 基础属性字段

所有基础属性都是可选的，默认值为 0，范围 0-99：

- `base_str` - 力量
- `base_agi` - 敏捷
- `base_vit` - 体质
- `base_wlp` - 意志
- `base_int` - 智力
- `base_wis` - 感知
- `base_cha` - 魅力

### 属性类型代码字段

战斗属性类型代码用于引用 `game_config.hero_attribute_type` 表中定义的属性类型。每个属性类型包含计算公式和其他元数据。

**可用的属性类型代码**:
- `ACCURACY` - 精准（默认公式: STR*2+AGI）
- `DODGE` - 闪避（默认公式: AGI*2+WIS）
- `INITIATIVE` - 先攻（默认公式: AGI*2+WIS）
- `BODY_RESIST` - 体质豁免（默认公式: VIT*2+WLP）
- `MAGIC_RESIST` - 魔法豁免（默认公式: WLP*2+WIS）
- `MENTAL_RESIST` - 精神豁免（默认公式: WIS*2+WLP）
- `ENVIRONMENT_RESIST` - 环境豁免（默认公式: VIT+WLP）

**说明**:
- 如果不指定属性类型代码，系统会使用上述默认值
- 属性类型代码必须在 `game_config.hero_attribute_type` 表中存在
- 怪物与英雄共享相同的属性类型定义，确保计算逻辑一致

### 技能配置

每个技能包含：

- `skill_code` (必填): 技能代码，必须在 `game_config.skills` 表中存在
- `skill_level` (必填): 技能等级，范围 1-20
- `gain_actions` (可选): 获得的动作代码列表

### 掉落配置

每个掉落包含：

- `drop_pool_code` (必填): 掉落池代码，必须在 `game_config.drop_pools` 表中存在
- `drop_type` (必填): 掉落类型，`team`（队伍共享）或 `personal`（个人）
- `drop_chance` (必填): 掉落概率，范围 (0, 1]，1.0 表示必定掉落
- `min_quantity` (必填): 最小数量，>=1
- `max_quantity` (必填): 最大数量，>=min_quantity

### 标签配置

标签是字符串数组，每个标签代码必须在 `game_config.tags` 表中存在。

**常用标签**:
- 种族: Beast, Human, Goblin, Dwarf, Golem, Undead, Demon, Dragon
- 类型: Melee, Ranged, Caster, Tank, Support
- 特殊: Boss, Elite, Minion, Common

---

## 导入工具使用

### 本地环境导入

#### 增量导入（默认）

已存在的怪物会被更新，不存在的会被创建：

```bash
./scripts/game-config/import-monster-config-local.sh
```

#### 清空后导入

删除所有现有怪物配置，然后导入：

```bash
./scripts/game-config/import-monster-config-local.sh truncate
```

### 生产环境导入

生产环境导入需要设置环境变量并确认：

```bash
export DB_HOST=your-db-host
export DB_NAME=tsu_db
export DB_USER=tsu_user
export DB_PASSWORD=your-password

./scripts/game-config/import-monster-config-prod.sh
```

### Python 脚本直接使用

```bash
python3 scripts/game-config/import_monster_config.py \
  --env local \
  --mode incremental \
  --config configs/game/monsters/monsters.json
```

**参数说明**:
- `--env`: 环境，`local` 或 `prod`
- `--mode`: 导入模式，`incremental` 或 `truncate`
- `--config`: 配置文件路径

---

## 配置示例

完整示例请参考：`configs/game/monsters/monsters.json`

### 简单示例

```json
[
  {
    "monster_code": "SLIME",
    "monster_name": "史莱姆",
    "monster_level": 1,
    "max_hp": 10,
    "base_vit": 2,
    "drop_gold_min": 5,
    "drop_gold_max": 10,
    "drop_exp": 10,
    "tags": ["Beast", "Common"]
  }
]
```

---

## 常见问题

### Q1: 导入时提示"技能不存在"怎么办？

**A**: 确保技能已经在 `game_config.skills` 表中存在。可以先导入技能配置，再导入怪物配置。

### Q2: 导入时提示"掉落池不存在"怎么办？

**A**: 确保掉落池已经在 `game_config.drop_pools` 表中存在。可以先导入掉落池配置，再导入怪物配置。

### Q3: 如何更新已存在的怪物？

**A**: 使用 `incremental` 模式导入，工具会自动检测并更新已存在的怪物。

### Q4: 如何删除所有怪物重新导入？

**A**: 使用 `truncate` 模式：
```bash
./scripts/game-config/import-monster-config-local.sh truncate
```

### Q5: 掉落概率如何设置？

**A**: 掉落概率是 0-1 之间的小数：
- `0.5` = 50% 概率
- `0.8` = 80% 概率
- `1.0` = 100% 概率（必定掉落）

### Q6: 属性类型代码字段可以留空吗？

**A**: 可以。如果不设置属性类型代码，系统会使用默认的属性类型代码（如 ACCURACY、DODGE 等）。

### Q7: 如何验证配置文件格式？

**A**: 可以使用在线 JSON 验证工具，或者直接运行导入脚本，工具会自动验证并报告错误。

---

**文档版本**: 1.1
**最后更新**: 2025-11-04
**变更说明**: 将战斗属性公式字段改为属性类型代码字段，统一怪物与英雄的属性管理系统

