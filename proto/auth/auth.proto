syntax = "proto3";

package auth;

option go_package = "tsu-self/internal/pb/auth";

import "common/user.proto";
import "common/common.proto";

// Auth RPC 服务定义
service AuthService {
    // 用户注册
    rpc Register(RegisterRequest) returns (RegisterResponse);

    // 获取用户信息
    rpc GetUser(GetUserRequest) returns (GetUserResponse);

    // 更新登录信息
    rpc UpdateLoginInfo(UpdateLoginInfoRequest) returns (UpdateLoginInfoResponse);

    // 同步 Kratos 用户到业务数据库
    rpc SyncUserFromKratos(SyncUserFromKratosRequest) returns (SyncUserFromKratosResponse);

    // 用户登录
    rpc Login(LoginRequest) returns (LoginResponse);

    // 用户登出
    rpc Logout(LogoutRequest) returns (LogoutResponse);

    // ==================== 用户管理 ====================
    // 获取用户列表
    rpc GetUsers(GetUsersRequest) returns (GetUsersResponse);

    // 更新用户信息
    rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);

    // 封禁用户
    rpc BanUser(BanUserRequest) returns (BanUserResponse);

    // 解禁用户
    rpc UnbanUser(UnbanUserRequest) returns (UnbanUserResponse);

    // 删除用户 (软删除 + Kratos identity 删除)
    rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse);
}

// ==================== Register ====================

message RegisterRequest {
    string email = 1;
    string username = 2;
    string password = 3;
}

message RegisterResponse {
    string user_id = 1;
    string kratos_id = 2;
    string email = 3;
    string username = 4;
    bool need_verify = 5;      // 是否需要邮箱验证
    string session_token = 6;  // Registration Flow 返回的 session token（用户可直接登录）
}

// ==================== GetUser ====================

message GetUserRequest {
    string user_id = 1;
}

message GetUserResponse {
    common.UserInfo user = 1;
}

// ==================== UpdateLoginInfo ====================

message UpdateLoginInfoRequest {
    string user_id = 1;
    string login_ip = 2;
}

message UpdateLoginInfoResponse {
    common.Status status = 1;
}

// ==================== SyncUserFromKratos ====================

message SyncUserFromKratosRequest {
    string kratos_id = 1;
}

message SyncUserFromKratosResponse {
    common.Status status = 1;
    common.UserInfo user = 2;  // 同步后的用户信息
}

// ==================== GetUsers (用户列表) ====================

message GetUsersRequest {
    int32 page = 1;
    int32 page_size = 2;
    string keyword = 3;
    optional bool is_banned = 4;
    string sort_by = 5;
    string sort_dir = 6;
}

message GetUsersResponse {
    repeated common.UserInfo users = 1;
    int64 total = 2;
    int32 page = 3;
    int32 page_size = 4;
    int32 total_pages = 5;
}

// ==================== UpdateUser ====================

message UpdateUserRequest {
    string user_id = 1;
    optional string username = 2;
    optional string email = 3;
    optional string nickname = 4;
    optional string phone_number = 5;
    optional string avatar_url = 6;
    optional string bio = 7;
    optional string birth_date = 8;
    optional string gender = 9;
    optional string timezone = 10;
    optional string language = 11;
}

message UpdateUserResponse {
    common.Status status = 1;
}

// ==================== BanUser ====================

message BanUserRequest {
    string user_id = 1;
    optional string ban_until = 2;
    string ban_reason = 3;
}

message BanUserResponse {
    common.Status status = 1;
}

// ==================== UnbanUser ====================

message UnbanUserRequest {
    string user_id = 1;
}

message UnbanUserResponse {
    common.Status status = 1;
}

// ==================== Login ====================

message LoginRequest {
    string identifier = 1;  // 可以是 email, username, 或 phone_number
    string password = 2;
    string session_token = 3; // 可选: 复用现有 session
    string client_service = 4; // 调用方服务(admin/game)
}

message LoginResponse {
    string session_token = 1;
    string user_id = 2;
    string email = 3;
    string username = 4;
}

// ==================== Logout ====================

message LogoutRequest {
    string session_token = 1;
    string client_service = 2;
}

message LogoutResponse {
    common.Status status = 1;
}

// ==================== 密码重置 ====================

// 密码恢复 - 请求验证码
message InitiateRecoveryRequest {
    string email = 1;
}

message InitiateRecoveryResponse {
    bool code_sent = 1;  // 验证码是否发送成功
    string message = 2;  // 提示信息
    // flow_id 已移除：后端通过 Redis 管理，前端不需要知道
}

// 密码恢复 - 验证验证码
message VerifyRecoveryCodeRequest {
    string email = 1;  // 用户邮箱（后端通过 email 从 Redis 获取 flow_id）
    string code = 2;    // 验证码
    // flow_id 已移除：后端通过 Redis 管理
}

message VerifyRecoveryCodeResponse {
    bool verified = 1;
    string message = 2;
    string session_token = 3;  // Kratos 特权 session token（用于步骤3重置密码）
}

// 重置密码
message ResetPasswordRequest {
    string session_token = 1; // 从步骤2返回的 Kratos 特权 session token
    string email = 2;         // 用户邮箱（用于验证）
    string new_password = 3;  // 新密码
}

message ResetPasswordResponse {
    common.Status status = 1;
    string message = 2;
}

// 验证码重置密码（验证码 + 新密码）
message ResetPasswordWithCodeRequest {
    string email = 1;         // 用户邮箱
    string code = 2;          // 验证码
    string new_password = 3;  // 新密码
}

message ResetPasswordWithCodeResponse {
    common.Status status = 1;
    string message = 2;
}

// ==================== DeleteUser ====================

message DeleteUserRequest {
    string user_id = 1;
}

message DeleteUserResponse {
    common.Status status = 1;
    string message = 2;
}
