# ğŸš€ TSU é¡¹ç›®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¿«é€ŸæŒ‡å—

## ğŸ“¦ å·²åˆ›å»ºçš„æ–‡ä»¶

```
tsu-self/
â”œâ”€â”€ deployments/
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â”œâ”€â”€ Dockerfile.admin.prod         # ç”Ÿäº§ç¯å¢ƒ Admin æœåŠ¡é•œåƒ
â”‚   â”‚   â””â”€â”€ Dockerfile.postgres.prod      # ç”Ÿäº§ç¯å¢ƒ PostgreSQL é•œåƒ
â”‚   â””â”€â”€ docker-compose/
â”‚       â””â”€â”€ docker-compose.prod.yml       # ç”Ÿäº§ç¯å¢ƒç¼–æ’é…ç½®
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy.sh                         # ğŸ¯ ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ server-init.sh                    # æœåŠ¡å™¨åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ configs/environments/
â”‚   â””â”€â”€ .env.prod.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ docs/
    â””â”€â”€ DEPLOYMENT.md                     # è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
```

---

## âš¡ å¿«é€Ÿå¼€å§‹ï¼ˆ3 æ­¥éƒ¨ç½²ï¼‰

### æ­¥éª¤ 1: é…ç½®æœåŠ¡å™¨ä¿¡æ¯

è„šæœ¬ä¸­å·²ç»é…ç½®å¥½æœåŠ¡å™¨ä¿¡æ¯ï¼š
- **IP**: 47.239.139.109
- **ç”¨æˆ·**: root
- **å¯†ç **: J8Do8e8Oiv

### æ­¥éª¤ 2: è¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
# æ–¹æ³• 1: ä½¿ç”¨ Makefileï¼ˆæ¨èï¼‰
make deploy

# æ–¹æ³• 2: ç›´æ¥è¿è¡Œè„šæœ¬
./scripts/deploy.sh
```

### æ­¥éª¤ 3: éªŒè¯éƒ¨ç½²

```bash
# è®¿é—®æœåŠ¡
curl http://47.239.139.109:8071/health
curl http://47.239.139.109:8070  # Swagger UI
```

**å°±è¿™ä¹ˆç®€å•ï¼** ğŸ‰

---

## ğŸ¯ deploy.sh è„šæœ¬åŠŸèƒ½

éƒ¨ç½²è„šæœ¬ä¼š**è‡ªåŠ¨å®Œæˆ**ä»¥ä¸‹æ‰€æœ‰æ“ä½œï¼š

1. âœ… **ç¯å¢ƒæ£€æŸ¥**: è‡ªåŠ¨å®‰è£… `sshpass` å·¥å…·
2. âœ… **è¿æ¥æµ‹è¯•**: éªŒè¯æœåŠ¡å™¨è¿æ¥
3. âœ… **ç¯å¢ƒåˆå§‹åŒ–**: è¯¢é—®æ˜¯å¦æ¸…ç†æ—§ç¯å¢ƒï¼ˆåˆ é™¤æ—§å®¹å™¨ã€PostgreSQLï¼‰
4. âœ… **æ–‡ä»¶ä¸Šä¼ **: è‡ªåŠ¨å‹ç¼©å¹¶ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
5. âœ… **ç¯å¢ƒé…ç½®**: è‡ªåŠ¨ç”Ÿæˆæˆ–ä½¿ç”¨ç°æœ‰ `.env.prod`
6. âœ… **é•œåƒæ„å»º**: åœ¨æœåŠ¡å™¨ä¸Šæ„å»º Docker é•œåƒ
7. âœ… **æœåŠ¡å¯åŠ¨**: ä½¿ç”¨ docker-compose å¯åŠ¨æ‰€æœ‰æœåŠ¡
8. âœ… **æ•°æ®åº“è¿ç§»**: è‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»

**é¢„è®¡è€—æ—¶**: 5-10 åˆ†é’Ÿï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰

---

## ğŸ”§ é¦–æ¬¡éƒ¨ç½²æ³¨æ„äº‹é¡¹

### ç¯å¢ƒåˆå§‹åŒ–é€‰é¡¹

è¿è¡Œ `./scripts/deploy.sh` æ—¶ï¼Œä¼šè¯¢é—®ï¼š

```
æ˜¯å¦éœ€è¦æ¸…ç†æœåŠ¡å™¨æ—§ç¯å¢ƒï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ Docker å®¹å™¨å’Œ PostgreSQL æ•°æ®ï¼(yes/no):
```

**é¦–æ¬¡éƒ¨ç½²**: è¾“å…¥ `yes`ï¼ˆæ¸…ç†å¹²å‡€ï¼Œä»å¤´å¼€å§‹ï¼‰

**åç»­æ›´æ–°**: è¾“å…¥ `no`ï¼ˆä¿ç•™æ•°æ®ï¼‰

### ç¯å¢ƒå˜é‡é…ç½®

è„šæœ¬ä¼šæ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ `.env.prod` æ–‡ä»¶ï¼š

**é€‰é¡¹ 1**: æ‰‹åŠ¨åˆ›å»ºï¼ˆæ¨èï¼‰
```bash
# å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
cp configs/environments/.env.prod.example .env.prod

# ç¼–è¾‘é…ç½®ï¼ˆä¿®æ”¹å¯†ç ï¼‰
nano .env.prod
```

**é€‰é¡¹ 2**: è‡ªåŠ¨ç”Ÿæˆ
è„šæœ¬ä¼šè¯¢é—®æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆï¼Œé€‰æ‹© `yes` ä¼šä½¿ç”¨éšæœºå¯†ç åˆ›å»ºé…ç½®ã€‚

---

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤

### æœ¬åœ°æ“ä½œ

```bash
# éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
make deploy

# æœ¬åœ°æµ‹è¯•ç”Ÿäº§ç¯å¢ƒé•œåƒ
make prod-build
make prod-up
make prod-logs
```

### æœåŠ¡å™¨æ“ä½œ

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@47.239.139.109

cd /opt/tsu/app

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f deployments/docker-compose/docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f deployments/docker-compose/docker-compose.prod.yml logs -f

# é‡å¯æœåŠ¡
docker-compose -f deployments/docker-compose/docker-compose.prod.yml restart

# åœæ­¢æœåŠ¡
docker-compose -f deployments/docker-compose/docker-compose.prod.yml down

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

---

## ğŸ”„ åç»­æ›´æ–°éƒ¨ç½²

ä¿®æ”¹ä»£ç åï¼Œé‡æ–°éƒ¨ç½²ï¼š

```bash
# é‡æ–°è¿è¡Œéƒ¨ç½²è„šæœ¬
make deploy

# æˆ–ç›´æ¥è¿è¡Œ
./scripts/deploy.sh
```

**æ³¨æ„**: æ›´æ–°æ—¶é€‰æ‹© `no` è·³è¿‡ç¯å¢ƒåˆå§‹åŒ–ï¼Œä»¥ä¿ç•™æ•°æ®åº“æ•°æ®ã€‚

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. sshpass å®‰è£…å¤±è´¥

**macOS ç”¨æˆ·**:
```bash
brew install hudochenkov/sshpass/sshpass
```

**Linux ç”¨æˆ·**:
```bash
sudo apt-get install sshpass  # Ubuntu/Debian
sudo yum install sshpass      # CentOS/RHEL
```

### 2. SSH è¿æ¥å¤±è´¥

æ£€æŸ¥æœåŠ¡å™¨ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼š
```bash
# ç¼–è¾‘è„šæœ¬
nano scripts/deploy.sh

# ä¿®æ”¹ä»¥ä¸‹å˜é‡
SERVER_HOST="47.239.139.109"
SERVER_USER="root"
SERVER_PASSWORD="J8Do8e8Oiv"
```

### 3. å®¹å™¨å¯åŠ¨å¤±è´¥

SSH åˆ°æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
ssh root@47.239.139.109
cd /opt/tsu/app
docker-compose -f deployments/docker-compose/docker-compose.prod.yml logs
```

### 4. æ•°æ®åº“è¿ç§»å¤±è´¥

æ‰‹åŠ¨æ‰§è¡Œè¿ç§»ï¼š
```bash
ssh root@47.239.139.109
cd /opt/tsu/app
source .env.prod
migrate -database "postgres://$DB_USER:$DB_PASSWORD@localhost:5432/$DB_NAME?sslmode=disable" -path ./migrations up
```

---

## ğŸ“Š æœåŠ¡æ¶æ„

éƒ¨ç½²åçš„æœåŠ¡æ¶æ„ï¼š

```
Internet
    â”‚
    â”œâ”€ :8070 â†’ Swagger UI (API æ–‡æ¡£)
    â”œâ”€ :8071 â†’ Admin Service (ç®¡ç†æœåŠ¡)
    â”‚
    â””â”€ å†…éƒ¨ç½‘ç»œ
        â”œâ”€ PostgreSQL (5432)
        â”œâ”€ Redis (6379)
        â”œâ”€ NATS (4222)
        â””â”€ Consul (8500)
```

---

## ğŸ“š æ›´å¤šæ–‡æ¡£

è¯¦ç»†çš„éƒ¨ç½²å’Œç»´æŠ¤æ–‡æ¡£ï¼š[docs/DEPLOYMENT.md](../docs/DEPLOYMENT.md)

åŒ…å«ï¼š
- æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤
- é…ç½®è¯¦è§£
- æ•…éšœæ’æŸ¥
- æ•°æ®åº“å¤‡ä»½æ¢å¤
- ç›‘æ§é…ç½®

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨å¯ä»¥ SSH è¿æ¥
- [ ] æœåŠ¡å™¨æœ‰ Docker å’Œ Docker Compose
- [ ] æœåŠ¡å™¨å¼€æ”¾äº† 8070 å’Œ 8071 ç«¯å£
- [ ] å·²åˆ›å»ºæˆ–å‡†å¤‡å¥½ `.env.prod` é…ç½®æ–‡ä»¶
- [ ] å·²ä¿®æ”¹é»˜è®¤å¯†ç ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰
- [ ] è¿è¡Œ `make deploy` æˆ– `./scripts/deploy.sh`
- [ ] éªŒè¯æœåŠ¡å¯è®¿é—®

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å¯ä»¥ï¼š

1. **è®¿é—® API**: http://47.239.139.109:8071
2. **æŸ¥çœ‹æ–‡æ¡£**: http://47.239.139.109:8070
3. **æŸ¥çœ‹ç›‘æ§**: ä½¿ç”¨ `docker stats` æŸ¥çœ‹èµ„æºä½¿ç”¨

æœ‰é—®é¢˜è¯·æŸ¥çœ‹ [DEPLOYMENT.md](../docs/DEPLOYMENT.md) æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚
