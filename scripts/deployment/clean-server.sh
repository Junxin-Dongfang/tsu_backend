#!/bin/bash

# ==========================================
# æ¸…ç†æœåŠ¡å™¨è„šæœ¬
# ==========================================
# åŠŸèƒ½ï¼šæ¸…ç†æ‰€æœ‰å®¹å™¨ã€é•œåƒã€æ•°æ®å·å’Œéƒ¨ç½²æ–‡ä»¶

set -e

# åŠ è½½é€šç”¨å‡½æ•°åº“
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/deploy-common.sh"

print_step "æ¸…ç†æœåŠ¡å™¨ç¯å¢ƒ"

echo ""
echo -e "${RED}âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š${NC}"
echo "  - æ‰€æœ‰ Docker å®¹å™¨"
echo "  - æ‰€æœ‰ Docker é•œåƒ"
echo "  - æ‰€æœ‰ Docker æ•°æ®å·ï¼ˆåŒ…æ‹¬æ•°æ®åº“æ•°æ®ï¼‰"
echo "  - éƒ¨ç½²ç›®å½• $SERVER_DEPLOY_DIR"
echo ""
read -p "ç¡®è®¤æ¸…ç†ï¼Ÿè¯·è¾“å…¥ 'yes' ç»§ç»­: " confirm

if [ "$confirm" != "yes" ]; then
    print_info "æ¸…ç†å·²å–æ¶ˆ"
    exit 0
fi

# ==========================================
# 1. æµ‹è¯•æœåŠ¡å™¨è¿æ¥
# ==========================================
print_step "[1/5] æµ‹è¯•æœåŠ¡å™¨è¿æ¥"
test_ssh_connection || exit 1

# ==========================================
# 2. åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨
# ==========================================
print_step "[2/5] åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨"

print_info "åœæ­¢æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨..."
ssh_exec "docker ps -q | xargs -r docker stop" || true

print_info "åˆ é™¤æ‰€æœ‰å®¹å™¨..."
ssh_exec "docker ps -aq | xargs -r docker rm -f" || true

print_success "å®¹å™¨æ¸…ç†å®Œæˆ"

# ==========================================
# 3. åˆ é™¤æ‰€æœ‰é•œåƒ
# ==========================================
print_step "[3/5] åˆ é™¤æ‰€æœ‰é•œåƒ"

print_info "åˆ é™¤æ‰€æœ‰ Docker é•œåƒ..."
ssh_exec "docker images -q | xargs -r docker rmi -f" || true

print_success "é•œåƒæ¸…ç†å®Œæˆ"

# ==========================================
# 4. åˆ é™¤æ‰€æœ‰æ•°æ®å·
# ==========================================
print_step "[4/5] åˆ é™¤æ‰€æœ‰æ•°æ®å·"

print_info "åˆ é™¤æ‰€æœ‰ Docker æ•°æ®å·..."
ssh_exec "docker volume ls -q | xargs -r docker volume rm -f" || true

print_success "æ•°æ®å·æ¸…ç†å®Œæˆ"

# ==========================================
# 5. åˆ é™¤ Docker ç½‘ç»œ
# ==========================================
print_step "[5/5] æ¸…ç† Docker ç½‘ç»œ"

print_info "åˆ é™¤è‡ªå®šä¹‰ç½‘ç»œ..."
ssh_exec "docker network rm tsu_network" || true

print_success "ç½‘ç»œæ¸…ç†å®Œæˆ"

# ==========================================
# 6. åˆ é™¤éƒ¨ç½²ç›®å½•
# ==========================================
print_step "åˆ é™¤éƒ¨ç½²ç›®å½•"

print_info "åˆ é™¤ $SERVER_DEPLOY_DIR ..."
ssh_exec "rm -rf $SERVER_DEPLOY_DIR"

print_success "éƒ¨ç½²ç›®å½•æ¸…ç†å®Œæˆ"

# ==========================================
# å®Œæˆ
# ==========================================
print_step "âœ… æœåŠ¡å™¨æ¸…ç†å®Œæˆï¼"

echo ""
echo -e "${GREEN}æ¸…ç†æ‘˜è¦ï¼š${NC}"
echo "  âœ“ Docker å®¹å™¨å·²æ¸…ç†"
echo "  âœ“ Docker é•œåƒå·²æ¸…ç†"
echo "  âœ“ Docker æ•°æ®å·å·²æ¸…ç†"
echo "  âœ“ Docker ç½‘ç»œå·²æ¸…ç†"
echo "  âœ“ éƒ¨ç½²ç›®å½•å·²æ¸…ç†"
echo ""
echo -e "${BLUE}ä¸‹ä¸€æ­¥ï¼š${NC}"
echo "  å¯ä»¥å¼€å§‹å…¨æ–°éƒ¨ç½²"
echo "  è¿è¡Œ: make deploy-prod-step1"
echo ""

print_success "ğŸ‰ æœåŠ¡å™¨ç¯å¢ƒå·²é‡ç½®ï¼"
