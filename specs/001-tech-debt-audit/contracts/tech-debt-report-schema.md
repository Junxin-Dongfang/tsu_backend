# 技术债务报告格式规范

**版本**: 1.0.0
**创建日期**: 2025-10-21
**适用范围**: TSU 项目技术债务审计报告

## 概述

本文档定义技术债务审计报告(TECH_DEBT.md)的标准 Markdown 格式规范,确保报告的一致性、可读性和可维护性。

---

## 文件结构

### 完整的报告模板

```markdown
# TSU 项目技术债务审计报告

> **重要说明**: 本报告记录截至 [日期] 的历史代码债务,仅用于渐进式改进指导,不代表立即修复要求。
> 所有问题应遵循"童子军军规"原则,在触碰相关代码时顺手改进。

## 执行摘要

**审计日期**: YYYY-MM-DD
**审计范围**: [列出审计的主要目录]
**审计方法**: 静态分析 + 人工代码审查
**审计时间**: [实际耗时]

**发现问题总数**: XX 个

**按严重程度分布**:
- 🔴 严重: XX 个 (占 XX%)
- 🟡 中等: XX 个 (占 XX%)
- 🟢 轻微: XX 个 (占 XX%)

**按宪法原则分布**:
| 原则 | 问题数 | 占比 |
|------|--------|------|
| 一、代码质量优先 | XX | XX% |
| 二、测试驱动开发 | XX | XX% |
| 三、用户体验一致性 | XX | XX% |
| 四、性能与资源效率 | XX | XX% |
| 五、可观测性与调试 | XX | XX% |
| **合计** | **XX** | **100%** |

## 关键发现

### Top 5 最严重问题

1. **[问题ID]**: [问题简述] - [影响说明]
2. **[问题ID]**: [问题简述] - [影响说明]
3. **[问题ID]**: [问题简述] - [影响说明]
4. **[问题ID]**: [问题简述] - [影响说明]
5. **[问题ID]**: [问题简述] - [影响说明]

### 主要模式和趋势

- **[模式1]**: [描述常见的问题模式]
- **[模式2]**: [描述另一个问题模式]
- **[趋势]**: [描述整体趋势]

### 改进建议优先级

根据问题严重程度和影响范围,建议优先改进以下领域:

1. **[领域1]**: [理由]
2. **[领域2]**: [理由]
3. **[领域3]**: [理由]

---

## 一、代码质量优先

> **宪法原则**: 所有代码必须通过 golangci-lint 检查,遵循 Go 最佳实践,包含完整文档注释,实现显式错误处理。

### 🔴 严重问题

#### CQ-XXX: [问题标题]

- **文件**: `[文件路径]:[起始行]-[结束行]`
- **违反条款**: [具体的宪法条款]
- **问题描述**:
  [详细描述问题,包括:]
  - 问题的具体表现
  - 为什么违反宪法
  - 潜在的影响和风险

- **代码示例**:
  ```go
  // 有问题的代码片段
  ```

- **影响范围**: [说明影响的功能模块、用户数量等]

- **改进建议**:
  1. [具体步骤1]
  2. [具体步骤2]
  3. [具体步骤3]

- **参考资料**: [可选,相关文档或最佳实践链接]

---

### 🟡 中等问题

[按照与严重问题相同的格式列出]

---

### 🟢 轻微问题

[按照与严重问题相同的格式列出]

---

## 二、测试驱动开发(不可协商)

> **宪法原则**: 单元测试必须在实现之前编写,所有新功能必须包含集成测试,测试覆盖率至少 80%。

[按照一、代码质量优先的格式组织问题]

---

## 三、用户体验一致性

> **宪法原则**: 所有 API 响应必须遵循标准化 JSON 格式,错误消息必须清晰可操作,HTTP 状态码必须正确。

[按照一、代码质量优先的格式组织问题]

---

## 四、性能与资源效率

> **宪法原则**: API 端点 p95 延迟 <200ms,数据库查询必须优化,避免 N+1 查询,高效使用 goroutine。

[按照一、代码质量优先的格式组织问题]

---

## 五、可观测性与调试

> **宪法原则**: 关键操作必须包含结构化日志,错误必须记录堆栈跟踪,API 端点必须暴露 Prometheus 指标。

[按照一、代码质量优先的格式组织问题]

---

## 附录

### 附录 A: 审计方法说明

**静态分析工具**:
- `golangci-lint` - 代码质量检查
- `gocyclo` - 复杂度分析
- `go vet` - 潜在 bug 检测

**人工审查重点**:
- 核心业务逻辑正确性
- 架构设计合理性
- 宪法原则合规性

**审计流程**:
1. 快速扫描(静态分析工具)
2. 核心模块深度审查
3. 关键基础设施检查
4. 整理和优先级排序

---

### 附录 B: 问题严重程度定义

**🔴 严重 (CRITICAL)**:
- 安全漏洞(SQL 注入、XSS、敏感信息泄露)
- 严重性能问题(N+1 查询、goroutine 泄漏)
- 核心业务逻辑无测试覆盖
- 错误被静默吞噬
- API 行为不一致

**🟡 中等 (MODERATE)**:
- 缺少文档注释
- 测试覆盖率 <80%
- 缺少日志或日志缺少上下文
- 代码复杂度高(圈复杂度 >15)
- 缺少监控指标

**🟢 轻微 (MINOR)**:
- 命名不规范
- 代码风格不一致
- 注释拼写错误
- HTTP 状态码使用不规范(但不影响功能)

---

### 附录 C: 改进优先级建议

根据宪法"历史代码处理"原则,建议采用以下策略:

**立即处理(本季度)**:
- 所有🔴严重安全漏洞
- 导致生产事故的性能问题
- 核心业务逻辑的关键 bug

**渐进改进(未来 6 个月)**:
- 在修改代码时应用"童子军军规",顺手修复相关的🟡中等问题
- 为新修改的代码补充单元测试
- 逐步完善日志和监控

**长期优化(未来 12 个月)**:
- 系统性重构高复杂度模块
- 提升整体测试覆盖率至 80%
- 统一 API 响应格式

---

## 维护说明

### 报告更新策略

- **定期更新**: 建议每季度重新审计,跟踪改进进度
- **增量更新**: 当完成某个问题的修复后,在报告中标记为"已修复"
- **版本管理**: 通过 Git 跟踪报告变更历史

### 问题跟踪

建议在修复问题时:
1. 在提交消息中引用问题 ID(如 "fix: 修复 CQ-001 错误处理问题")
2. 在代码审查时检查是否符合宪法原则
3. 定期审查已修复问题,确保修复质量

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2025-10-21 | 初始审计报告 |

---

**报告生成日期**: YYYY-MM-DD
**审计执行**: [执行人或团队]
**宪法版本**: 1.1.0
```

---

## 格式规范细节

### 问题 ID 命名规则

格式: `{原则缩写}-{三位数字序号}`

**原则缩写**:
- `CQ` - 代码质量优先 (Code Quality)
- `TD` - 测试驱动开发 (Test-Driven Development)
- `UX` - 用户体验一致性 (User Experience)
- `PF` - 性能与资源效率 (Performance)
- `OB` - 可观测性与调试 (Observability)

**示例**: CQ-001, TD-023, UX-007

### 严重程度标记

- 🔴 严重: `:red_circle:` 或 🔴
- 🟡 中等: `:yellow_circle:` 或 🟡
- 🟢 轻微: `:green_circle:` 或 🟢

### 代码片段格式

```go
// 使用 Go 语法高亮
func example() {
    // 代码内容
}
```

### 文件路径格式

- 使用相对于项目根目录的路径
- 包含行号范围: `path/to/file.go:123-145`
- 单行问题: `path/to/file.go:123`

### 表格格式

使用 Markdown 表格,确保对齐:

```markdown
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 值1 | 值2 | 值3 |
```

---

## 质量检查清单

在提交报告前,确保:

- [ ] 问题总数在 20-100 之间
- [ ] 每个宪法原则至少 3 个问题
- [ ] 所有问题 ID 唯一且遵循命名规则
- [ ] 所有问题包含必填字段:
  - [ ] 文件路径
  - [ ] 违反条款
  - [ ] 问题描述
  - [ ] 改进建议
- [ ] 严重程度分布合理(避免全是严重或全是轻微)
- [ ] 执行摘要统计数据准确
- [ ] 所有代码片段格式正确
- [ ] 所有链接有效
- [ ] 中文语法和拼写正确

---

## 使用工具

推荐使用以下工具处理报告:

1. **Markdown 编辑器**: VS Code + Markdown Preview Enhanced
2. **格式检查**: `markdownlint`
3. **链接检查**: `markdown-link-check`
4. **表格生成**: [Tables Generator](https://www.tablesgenerator.com/markdown_tables)

---

## 常见问题

**Q: 如果某段代码同时违反多个原则,应该记录几次?**

A: 选择最主要的原则记录一次,在问题描述中提及其他原则,必要时通过"相关问题"字段关联。

**Q: 问题描述应该多详细?**

A: 应包含足够的上下文让不熟悉代码的开发者理解问题,但避免过度冗长。推荐 100-300 字。

**Q: 是否需要为所有问题提供代码片段?**

A: 严重问题强烈建议提供,中等和轻微问题根据情况决定。代码片段有助于快速理解问题。

**Q: 改进建议应该多具体?**

A: 应提供可操作的步骤,但不需要包含完整的实现代码。目标是指导而非替代思考。

---

## 附加资源

- [项目宪法](../../.specify/memory/constitution.md)
- [Go 代码审查评论](https://github.com/golang/go/wiki/CodeReviewComments)
- [Effective Go](https://golang.org/doc/effective_go)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
