# 研究文档: 技术债务审计方法

**功能**: 技术债务审计
**阶段**: Phase 0 - 研究与决策
**创建日期**: 2025-10-21

## 研究目标

本研究旨在确定如何有效地对现有代码库进行技术债务审计,识别与项目宪法冲突的代码模式,并以结构化、可操作的方式记录问题。

## 研究问题

1. **如何系统性地审计代码库?**
2. **如何识别与宪法原则的冲突?**
3. **如何有效组织和呈现审计结果?**
4. **如何确保审计结果可操作且有价值?**

---

## 决策 1: 审计方法

### 选择: 混合式审计方法(静态分析 + 人工审查)

**理由**:
- **静态分析工具**可快速识别明显的代码质量问题(如缺少错误处理、代码复杂度等)
- **人工审查**能够识别更深层次的架构问题和宪法原则违规
- 结合两者可以平衡效率和准确性

**具体实施**:

1. **自动化静态分析**:
   - 使用 `golangci-lint` 识别代码质量问题
   - 使用 `gocyclo` 检测高复杂度函数
   - 使用 `go vet` 查找潜在 bug

2. **人工代码审查**:
   - 按宪法五大原则系统性检查代码
   - 重点审查核心业务逻辑模块
   - 识别架构层面的问题

3. **问题优先级排序**:
   - 根据与宪法冲突的严重程度排序
   - 优先记录影响范围大的问题
   - 聚焦于 20-100 个最关键问题

**考虑的替代方案**:
- ❌ **纯静态分析** - 无法识别深层架构问题和业务逻辑缺陷
- ❌ **纯人工审查** - 耗时过长,可能遗漏明显的代码质量问题
- ❌ **动态运行时分析** - 需要运行系统,成本高且不适合历史代码审计

---

## 决策 2: 问题分类框架

### 选择: 按宪法五大原则分类 + 严重程度标记

**理由**:
- 与项目宪法直接对应,便于团队理解
- 支持按原则制定针对性改进计划
- 严重程度标记帮助优先级排序

**分类结构**:

```
I. 代码质量原则
   ├── 🔴 严重: 安全漏洞、SQL 注入风险
   ├── 🟡 中等: 缺少文档、命名不清晰
   └── 🟢 轻微: 代码风格不一致

II. 测试驱动开发原则
   ├── 🔴 严重: 核心业务逻辑无测试
   ├── 🟡 中等: 测试覆盖率 <80%
   └── 🟢 轻微: 缺少边界情况测试

III. 用户体验一致性原则
   ├── 🔴 严重: API 响应格式不一致
   ├── 🟡 中等: 错误消息不清晰
   └── 🟢 轻微: HTTP 状态码使用不规范

IV. 性能与资源效率原则
   ├── 🔴 严重: N+1 查询问题、goroutine 泄漏
   ├── 🟡 中等: 缺少数据库索引、未使用连接池
   └── 🟢 轻微: 热路径中的小型内存分配

V. 可观测性与调试原则
   ├── 🔴 严重: 关键操作无日志、错误被静默吞噬
   ├── 🟡 中等: 缺少 Prometheus 指标、日志缺少上下文
   └── 🟢 轻微: 日志级别使用不当
```

**考虑的替代方案**:
- ❌ **按文件/模块分类** - 不利于理解整体问题模式
- ❌ **按问题类型分类**(bug、性能、安全等) - 与宪法脱节
- ❌ **扁平列表** - 难以导航和理解优先级

---

## 决策 3: 报告格式与结构

### 选择: 结构化 Markdown 文档 + 模板化问题条目

**理由**:
- Markdown 易于版本控制和协作审阅
- 结构化格式便于快速定位问题
- 模板化条目确保信息完整性

**报告结构模板**:

```markdown
# TSU 项目技术债务审计报告

## 执行摘要
- 审计日期: YYYY-MM-DD
- 审计范围: [目录列表]
- 发现问题总数: XX 个
- 按严重程度分布: 🔴 XX | 🟡 XX | 🟢 XX
- 按宪法原则分布: [统计表]

## 关键发现与建议
[Top 5-10 最严重问题的概述]

## 一、代码质量原则
### 🔴 严重问题
#### CQ-001: [问题标题]
- **文件**: `path/to/file.go:123-145`
- **违反条款**: 所有错误处理必须显式且有意义
- **问题描述**: [详细描述]
- **代码示例**: ```go [代码片段] ```
- **影响范围**: [影响说明]
- **改进建议**: [具体建议]

[更多问题...]

## 附录
### A. 审计方法说明
### B. 问题严重程度定义
### C. 改进优先级建议
```

**问题条目必填字段**:
1. **问题ID** - 便于跟踪引用
2. **文件路径 + 行号** - 快速定位
3. **违反的宪法条款** - 建立与宪法的直接联系
4. **问题描述** - 清晰解释问题
5. **代码示例** - 可选但推荐
6. **改进建议** - 可操作的指导

**考虑的替代方案**:
- ❌ **Excel/CSV** - 难以包含代码片段和详细描述
- ❌ **纯文本** - 缺少结构化,难以导航
- ❌ **Wiki 页面** - 需要额外工具,不易版本控制

---

## 决策 4: 审计范围界定

### 选择: 聚焦核心业务逻辑 + 关键基础设施

**理由**:
- 在有限时间内实现最大价值
- 核心业务逻辑的问题影响最大
- 基础设施代码的问题会波及整个系统

**审计优先级**:

**🔴 高优先级(必须审计)**:
- `internal/game/` - 游戏核心逻辑
- `internal/auth/` - 认证授权逻辑
- `internal/common/` - 共享组件
- `scripts/deployment/` - 部署脚本(影响生产稳定性)

**🟡 中优先级(重点抽查)**:
- `cmd/` - 应用启动入口
- `migrations/` - 数据库迁移脚本
- `internal/models/` - 非自动生成的模型代码

**🟢 低优先级(时间允许时审查)**:
- `scripts/` 中的其他工具脚本
- 配置文件
- 文档文件

**明确排除**:
- ❌ 自动生成的代码(如 SQLBoiler models)
- ❌ 第三方依赖库代码
- ❌ 测试数据和临时文件

**考虑的替代方案**:
- ❌ **全量审计** - 时间成本过高,问题过多难以聚焦
- ❌ **随机抽样** - 可能遗漏关键问题
- ❌ **仅审计最近修改的代码** - 无法全面了解技术债务状况

---

## 决策 5: 审计流程与时间规划

### 选择: 分阶段渐进式审计 + 边审计边记录

**理由**:
- 避免审计结束后遗忘问题细节
- 支持在时间约束内交付部分结果
- 便于调整审计重点

**审计流程**(预计 10 分钟):

**阶段 1: 快速扫描(2 分钟)**
- 使用静态分析工具扫描代码库
- 识别明显的代码质量问题
- 建立问题清单初稿

**阶段 2: 核心模块深度审查(5 分钟)**
- 按宪法五大原则审查 `internal/` 核心代码
- 重点查看关键业务逻辑函数
- 记录严重和中等问题

**阶段 3: 关键基础设施检查(2 分钟)**
- 审查部署脚本和迁移脚本
- 检查配置管理和错误处理
- 记录影响生产的问题

**阶段 4: 整理和优先级排序(1 分钟)**
- 按严重程度排序问题
- 完善问题描述和改进建议
- 生成执行摘要

**质量检查点**:
- ✅ 每个宪法原则至少 3 个问题示例
- ✅ 问题总数 20-100 个之间
- ✅ 80% 核心代码文件已覆盖
- ✅ 所有严重问题都有详细描述和改进建议

**考虑的替代方案**:
- ❌ **一次性完整审计后再记录** - 容易遗漏细节
- ❌ **先记录所有问题再分类** - 缺少结构,难以聚焦
- ❌ **完美主义审计** - 时间成本无法控制

---

## 决策 6: 数据库迁移工具与组织方式

### 当前状况分析

项目当前使用 `golang-migrate/migrate` 工具,所有迁移文件存放在单一的 `migrations/` 目录中:

```
migrations/
├── 000001_create_schemas.up.sql       # 创建schema
├── 000001_create_schemas.down.sql
├── 000002_create_core_infrastructure.up.sql
├── 000002_create_core_infrastructure.down.sql
├── 000003_create_users_system.up.sql
├── 000003_create_users_system.down.sql
├── 000004_create_game_config_schema_tables.up.sql
├── 000004_create_game_config_schema_tables.down.sql
├── 000005_create_game_runtime_schema_tables.up.sql
├── 000005_create_game_runtime_schema_tables.down.sql
├── ...                                # 共10个迁移版本
```

**Makefile 中的迁移命令**:
```makefile
migrate-create:  # 创建新迁移
    migrate create -ext sql -dir ./migrations -seq $$name
migrate-up:      # 应用所有新迁移
    migrate -database $(MAIN_DB_URL) -path ./migrations up
migrate-down:    # 回滚最后一个迁移
    migrate -database $(MAIN_DB_URL) -path ./migrations down 1
```

### 选择: 保持当前工具,优化组织方式

**理由**:
1. **golang-migrate/migrate 是成熟可靠的工具**
   - Go 生态中最流行的迁移工具
   - 支持多种数据库(PostgreSQL, MySQL, etc.)
   - 简单、稳定、无外部依赖
   - 与当前项目技术栈完美匹配

2. **单一目录结构适合当前规模**
   - 当前只有 10 个迁移文件,管理压力不大
   - 版本号命名清晰(000001-000010)
   - 易于查看迁移历史

3. **改进建议(而非完全重构)**:
   - 添加迁移命名约定(包含功能描述)
   - 改进文件注释(说明迁移目的)
   - 添加迁移文档(记录重要变更)

### 潜在改进方案

#### 方案 A: 按模块分子目录(不推荐)

```
migrations/
├── auth/
│   ├── 000003_create_users_system.up.sql
│   └── 000003_create_users_system.down.sql
├── game_config/
│   ├── 000004_create_game_config_schema_tables.up.sql
│   └── 000004_create_game_config_schema_tables.down.sql
└── game_runtime/
    ├── 000005_create_game_runtime_schema_tables.up.sql
    └── 000005_create_game_runtime_schema_tables.down.sql
```

**为何不推荐**:
- ❌ golang-migrate 不原生支持子目录
- ❌ 需要额外脚本合并迁移
- ❌ 增加复杂度,收益不明显
- ❌ 难以保证跨模块迁移的执行顺序

#### 方案 B: 改进命名约定(推荐)

保持单一目录,但改进文件命名:

```
migrations/
├── 000001_init_create_schemas.up.sql
├── 000001_init_create_schemas.down.sql
├── 000002_infra_create_core_infrastructure.up.sql
├── 000002_infra_create_core_infrastructure.down.sql
├── 000003_auth_create_users_system.up.sql
├── 000003_auth_create_users_system.down.sql
├── 000004_game_config_schema_tables.up.sql
├── 000004_game_config_schema_tables.down.sql
├── 000005_game_runtime_schema_tables.up.sql
├── 000005_game_runtime_schema_tables.down.sql
```

**命名约定**: `{版本号}_{模块前缀}_{描述}.{up|down}.sql`

**优点**:
- ✅ 保持简单的单目录结构
- ✅ 通过命名即可识别模块归属
- ✅ 无需修改工具链
- ✅ 易于搜索和过滤(如 `ls *auth*`)

### 替代工具评估

虽然保持当前工具,但简要评估其他选项供未来参考:

| 工具 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **golang-migrate** (当前) | 简单、稳定、Go 原生 | 功能基础,无复杂特性 | ⭐⭐⭐⭐⭐ |
| **goose** | 支持 Go 函数迁移 | 社区较小 | ⭐⭐⭐ |
| **atlas** | 现代、声明式schema | 学习曲线陡峭 | ⭐⭐⭐ |
| **dbmate** | 跨语言支持 | 非 Go 原生 | ⭐⭐ |
| **sql-migrate** | 功能丰富 | 过于复杂 | ⭐⭐ |

### 审计关注点

在审计中,针对迁移脚本关注:

1. **缺少回滚脚本** (🔴 严重)
   - 检查是否所有 `.up.sql` 都有对应的 `.down.sql`
   - 确保回滚脚本经过测试

2. **缺少注释** (🟡 中等)
   - 迁移文件应包含头部注释说明目的
   - 复杂SQL应有行内注释

3. **缺少事务包装** (🟡 中等)
   - 检查是否使用 `BEGIN;` 和 `COMMIT;`
   - 确保迁移原子性

4. **硬编码值** (🟢 轻微)
   - 避免在迁移中硬编码业务数据
   - 使用配置或环境变量

**示例问题条目**:

```markdown
#### MG-001: 迁移 000007 缺少事务包装

- **文件**: `migrations/000007_seed_rbac_data.up.sql`
- **违反条款**: 所有数据库操作必须有适当的错误处理和事务管理
- **问题描述**:
  种子数据插入操作未使用事务包装。如果中途失败,会导致部分数据
  插入成功而部分失败,造成数据不一致。
- **改进建议**:
  在文件开头添加 `BEGIN;`,结尾添加 `COMMIT;`
```

### 迁移最佳实践建议

添加到审计报告的"改进建议"部分:

1. **迁移文档化**
   - 在 `migrations/README.md` 中记录重大变更
   - 为破坏性变更提供迁移指南

2. **测试流程**
   - 在开发环境测试 up + down 循环
   - 在 staging 环境验证生产数据兼容性

3. **命名规范**
   - 采用 `{版本}_{模块}_{描述}` 格式
   - 描述应清晰说明变更目的

---

## 决策 7: 项目清理 - 识别和处理多余文件

### 审计发现的多余文件

通过扫描项目根目录,识别以下可能需要清理的文件:

#### 🟡 中等优先级清理

**1. QWEN.md (23KB)**
- **当前状态**: 可能是与 Qwen AI 模型相关的配置或说明文档
- **问题**:
  - 文件较大(23KB),但不在文档目录中
  - 项目已有 CLAUDE.md,说明可能存在多个 AI 工具配置
  - 可能与 .cursor/, .windsurf/ 目录功能重复
- **建议**:
  - 如果内容有价值,移动到 `docs/ai-tools/` 目录
  - 如果已过时,考虑删除
  - 如果与 CLAUDE.md 重复,合并或选择保留一个

**2. 已删除功能的遗留文档**
- 根据 git 历史,发现以下文档已被删除:
  ```
  2025-10-16task.md                    # 临时任务文档
  ADMIN_GAME_INDEPENDENCE_ANALYSIS.md # 管理服务器独立性分析
  CURRENT_API_SUMMARY.md              # API 摘要
  FINAL_TEST_REPORT.md                # 最终测试报告
  GAME_MODULE_REVIEW.md               # 游戏模块审查
  OPTIMIZATION_SUMMARY.md             # 优化总结
  TEST_REPORT.md                      # 测试报告
  ```
- **建议**: 已正确删除,无需进一步操作

**3. 脚本文档清理**
- `scripts/` 目录中的 README 文档已被删除:
  ```
  scripts/DEPLOYMENT_SCRIPT_AUDIT_REPORT.md
  scripts/README_DEPLOYMENT.md
  scripts/README_IMPORT.md
  ```
- **建议**: 已正确删除,但应考虑:
  - 在 `scripts/` 创建统一的 `README.md`
  - 记录各脚本的用途和使用方法

**4. 测试脚本清理**
- PowerShell 测试脚本已被删除:
  ```
  test_complete_flow.ps1
  test_flow.ps1
  test_game_api.ps1
  test_hero_flow.ps1
  ```
- **建议**: 已正确删除,但应:
  - 将测试逻辑迁移到 Go 测试文件
  - 或在 `scripts/` 目录保留一个通用测试脚本

**5. Python 脚本清理**
- `scripts/generate_test_token.py` 已被删除
- **建议**: 已正确删除,但应:
  - 确认功能是否被 Go 工具替代
  - 如果仍需要,用 Go 重写

#### 🟢 低优先级清理

**1. .DS_Store 文件**
- macOS 系统自动生成的隐藏文件
- **建议**: 添加到 `.gitignore`:
  ```gitignore
  # macOS
  .DS_Store
  .AppleDouble
  .LSOverride
  ```

**2. 临时构建产物**
- `main` 和 `game-server` 二进制文件
- **建议**: 确认 `.gitignore` 已包含:
  ```gitignore
  # Binaries
  /main
  /game-server
  *.exe
  ```

**3. 本地开发目录**
- `.ory-postgres-data/`
- `.postgres-data/`
- `.redis-data/`
- `.consul-data/`
- **建议**: 已在 `.gitignore` 中,无需操作

#### 🔴 严重 - 敏感文件检查

**1. 环境配置文件**
- `.env` (3.9KB)
- `.env.prod` (1.3KB)
- `.env.smtp` (1.3KB)
- **状态**: 这些文件应该存在于 `.gitignore` 中
- **检查点**:
  - ✅ 确认 `.gitignore` 包含 `.env*`
  - ⚠️ 审计是否包含敏感信息(数据库密码、API密钥)
  - ✅ 确保有 `.env.example` 模板文件

### 文件清理策略

#### 立即执行(本次审计)

在 TECH_DEBT.md 中记录以下问题:

```markdown
#### FC-001: QWEN.md 文件位置和用途不明确

- **文件**: `QWEN.md`
- **违反条款**: 项目结构必须清晰整洁
- **问题描述**:
  项目根目录存在 23KB 的 QWEN.md 文件,用途不明确。
  与 CLAUDE.md 并存,可能存在配置重复或过时文档。
- **建议**:
  1. 审查文件内容,确定是否仍需要
  2. 如有价值,移至 `docs/ai-tools/qwen.md`
  3. 如已过时,删除并记录在 CHANGELOG
  4. 如与 CLAUDE.md 功能重复,合并配置
```

#### 渐进式清理(未来 Sprint)

1. **建立文档规范**
   - 根目录只保留 README.md 和 LICENSE
   - 所有其他文档归入 `docs/` 目录
   - AI 工具配置归入 `.ai/` 或 `.claude/` 等隐藏目录

2. **定期清理检查**
   - 每季度审查临时文件和测试脚本
   - 删除超过 3 个月未使用的临时文档
   - 归档重要的历史文档到 `docs/archive/`

3. **自动化清理**
   - 添加 pre-commit hook 检测敏感文件
   - CI 流水线验证 .gitignore 完整性

### 审计报告中的文件清理章节

建议在 TECH_DEBT.md 中添加专门章节:

```markdown
## 六、项目清理与组织

> **宪法原则**: 保持项目完整、清晰、整洁

### 🟡 中等问题

#### FC-001: 根目录文档混乱
[详细描述...]

#### FC-002: 缺少scripts目录统一文档
[详细描述...]

### 改进建议

1. **短期(本 Sprint)**:
   - 审查 QWEN.md 并采取行动
   - 创建 scripts/README.md
   - 验证 .gitignore 完整性

2. **中期(下个季度)**:
   - 建立文档组织规范
   - 迁移散落的文档到 docs/ 目录
   - 实施定期清理流程

3. **长期**:
   - 自动化文件组织检查
   - 集成到 CI/CD 流水线
```

---

## 研究结论

通过以上**七个**关键决策,我们建立了一套全面的技术债务审计方法:

1. **方法**: 静态分析 + 人工审查的混合方式
2. **分类**: 按宪法五大原则 + 三级严重程度
3. **格式**: 结构化 Markdown 文档 + 标准化问题条目
4. **范围**: 聚焦核心业务逻辑和关键基础设施
5. **流程**: 四阶段渐进式审计,10 分钟内完成
6. **迁移管理**: 保持 golang-migrate,优化命名约定和文档
7. **项目清理**: 识别多余文件,建立清理策略

这套方法确保审计结果:
- ✅ **全面** - 覆盖所有宪法原则 + 迁移 + 项目组织
- ✅ **聚焦** - 识别最关键的问题
- ✅ **可操作** - 提供明确的改进建议
- ✅ **高效** - 在有限时间内完成
- ✅ **可维护** - 便于版本控制和协作
- ✅ **系统化** - 涵盖代码、数据库、文件组织等多个维度

---

## 后续步骤

基于以上研究结果,下一步将进入 Phase 1 设计阶段:
1. 创建 `data-model.md` - 定义问题条目的数据结构(包含迁移和文件清理类别)
2. 创建 `contracts/tech-debt-report-schema.md` - 规范报告格式(添加迁移和清理章节)
3. 创建 `quickstart.md` - 编写审计报告使用指南(包含迁移和清理最佳实践)
