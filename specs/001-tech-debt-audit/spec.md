# 功能规格说明: 技术债务审计

**Feature Branch**: `001-tech-debt-audit`
**Created**: 2025-10-21
**Status**: Draft
**Input**: User description: "为历史定罪,阅读当前的项目内容。行动:创建一个新的文件,TECH_DEBT.md。内容:浏览现有代码。把你看到的、与新《宪法》原则冲突最严重的问题,以列表的形式记录下来。切记,只记录,不修改!使用中文。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 审计代码质量问题 (优先级: P1)

作为开发团队成员,我需要了解现有代码库中哪些部分与新制定的项目宪法存在严重冲突,以便在未来的维护工作中有针对性地改进代码质量。

**为何设为此优先级**: 这是整个技术债务审计工作的核心,必须首先完成代码扫描和问题识别,才能进行后续的优先级排序和改进计划。这直接关系到团队对技术债务的认知和改进方向。

**独立测试**: 可以通过审查生成的 TECH_DEBT.md 文件来完全测试此功能。文件应包含按宪法原则分类的问题列表,每个问题都有具体的代码位置引用和问题描述。

**验收场景**:

1. **Given** 项目代码库存在多个与宪法原则冲突的代码片段, **When** 执行代码审计, **Then** 系统应生成 TECH_DEBT.md 文件,文件中包含所有识别出的主要问题
2. **Given** TECH_DEBT.md 文件已生成, **When** 开发人员查看文件内容, **Then** 每个问题都应包含清晰的问题描述、违反的宪法原则、具体的文件路径和行号
3. **Given** 代码库中存在不同严重程度的问题, **When** 审计完成, **Then** 问题应按照与宪法原则的冲突严重程度进行分类和排序

---

### 用户故事 2 - 问题分类与优先级排序 (优先级: P2)

作为技术负责人,我需要看到技术债务按照宪法五大原则(代码质量、测试驱动、用户体验、性能、可观测性)进行分类,以便制定有针对性的改进计划。

**为何设为此优先级**: 在识别出问题后,需要对问题进行系统性分类,帮助团队理解哪些宪法原则被违反得最严重,从而制定优先改进策略。

**独立测试**: 可以通过验证 TECH_DEBT.md 文件的结构来测试。文件应有清晰的章节划分,每个宪法原则都有对应的问题列表。

**验收场景**:

1. **Given** 审计发现了多个代码质量问题, **When** 生成报告, **Then** 所有问题应按照五大宪法原则进行分类
2. **Given** 某个宪法原则下存在多个问题, **When** 查看该分类, **Then** 问题应按照严重程度排序(严重问题在前)
3. **Given** 报告生成完成, **When** 查看文件结构, **Then** 应包含问题摘要统计(每个原则下有多少问题)

---

### 用户故事 3 - 生成可操作的改进建议 (优先级: P3)

作为开发人员,我希望对于每个识别出的问题,都能看到简要的改进方向建议,以便在触碰相关代码时知道如何应用"童子军军规"进行改进。

**为何设为此优先级**: 这是增值功能,在基础的问题识别和分类之上,提供改进指导可以加速团队的渐进式改进工作。

**独立测试**: 可以通过检查 TECH_DEBT.md 中每个问题是否包含"建议改进方向"字段来测试。

**验收场景**:

1. **Given** 某个代码文件缺少测试覆盖, **When** 查看该问题记录, **Then** 应包含"添加单元测试"的改进建议
2. **Given** 某个函数缺少错误处理, **When** 查看该问题记录, **Then** 应包含"实现显式错误处理和日志记录"的建议
3. **Given** 多个问题有相似的改进方向, **When** 生成报告, **Then** 应在问题类别开头提供通用的改进指导

---

### 边界情况

- 当代码文件过大(超过 2000 行)无法完整读取时,如何确保审计的完整性?
- 当某段代码同时违反多个宪法原则时,如何避免重复记录?
- 当代码库中存在自动生成的代码(如 ORM 模型)时,如何排除这些不应被审计的文件?
- 当某些历史代码已有明确的重构计划时,如何在报告中标注以避免重复工作?

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统**必须**能够扫描项目代码库中的主要源代码文件(Go 源文件、配置文件、数据库迁移脚本等)
- **FR-002**: 系统**必须**识别与五大宪法原则(代码质量、测试驱动、用户体验一致性、性能与资源效率、可观测性与调试)存在冲突的代码模式
- **FR-003**: 系统**必须**生成一个名为 TECH_DEBT.md 的中文技术债务报告文件
- **FR-004**: 报告**必须**按照五大宪法原则对问题进行分类组织
- **FR-005**: 每个识别出的问题**必须**包含:问题描述、违反的具体宪法条款、文件路径、代码片段或行号引用
- **FR-006**: 报告**必须**在文件开头包含执行摘要,总结发现的主要问题类别和数量
- **FR-007**: 系统**必须**优先识别最严重的问题(与宪法原则冲突最明显、影响最大的问题)
- **FR-008**: 报告**必须**采用 Markdown 格式,便于版本控制和协作审阅
- **FR-009**: 对于每类问题,报告**应该**提供简要的改进方向建议
- **FR-010**: 报告**必须**明确标注这是历史代码审计,不代表立即修复要求,符合宪法中"历史代码处理"原则

### 关键实体

- **技术债务项 (Tech Debt Item)**: 表示一个具体的代码问题,包含属性:问题标题、描述、严重程度、违反的宪法原则、文件路径、行号范围、代码片段、改进建议
- **宪法原则类别 (Constitution Principle Category)**: 五大原则之一(代码质量、测试驱动、用户体验、性能、可观测性),用于问题分类
- **审计报告 (Audit Report)**: 完整的 TECH_DEBT.md 文档,包含执行摘要、按原则分类的问题列表、改进建议汇总

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 生成的 TECH_DEBT.md 文件应覆盖项目中至少 80% 的核心源代码文件(internal/、cmd/、scripts/ 等目录)
- **SC-002**: 识别出的问题数量应在 20-100 个之间(过少说明审计不充分,过多说明没有聚焦于最严重问题)
- **SC-003**: 每个宪法原则类别下都应至少有 3 个具体问题示例
- **SC-004**: 100% 的问题记录都应包含准确的文件路径引用,便于开发人员快速定位
- **SC-005**: 报告生成时间应在 10 分钟内完成(考虑到需要人工审查代码)
- **SC-006**: 技术负责人审阅报告后,应能在 30 分钟内理解项目技术债务的整体状况和主要改进方向

## 假设条件

- 代码审计将主要关注 `internal/`, `cmd/`, `scripts/`, `migrations/` 等核心目录
- 自动生成的代码(如 SQLBoiler 生成的模型)将被排除在审计范围之外
- 审计将基于静态代码分析和人工审查,不涉及动态运行时分析
- 问题严重程度将基于与宪法原则的冲突程度和潜在影响范围判断
- 报告将使用中文编写,便于团队理解
- 此审计是一次性活动,未来可根据需要定期更新

## 范围界定

### 包含在内
- 审计现有代码与宪法原则的冲突
- 生成结构化的技术债务报告
- 提供改进方向建议
- 按宪法原则分类组织问题

### 不包含在内
- 自动修复代码问题(明确要求"只记录,不修改")
- 创建详细的重构任务计划
- 估算修复每个问题所需的工作量
- 提供完整的代码重构方案
- 执行动态代码分析或性能测试
- 审计第三方依赖库的代码质量
