# Implementation Tasks: 技术债务审计

**Feature**: 技术债务审计
**Branch**: `001-tech-debt-audit`
**Generated**: 2025-10-21
**Related Docs**: [spec.md](./spec.md) | [plan.md](./plan.md) | [research.md](./research.md) | [data-model.md](./data-model.md)

## Overview

本文档定义了技术债务审计功能的实施任务。该功能通过人工代码审查生成结构化的技术债务报告(TECH_DEBT.md),帮助团队识别与项目宪法冲突的代码模式。

**注意**: 本项目完全不考虑前端和战斗系统的具体实现,审计聚焦于后端核心业务逻辑、认证、通用组件和基础设施代码。

---

## Task Legend

- `- [ ]` = 待完成任务
- `[T###]` = 任务ID(按执行顺序编号)
- `[P]` = 可并行执行(与其他任务无依赖冲突)
- `[US#]` = 用户故事标签(US1=P1用户故事, US2=P2用户故事, US3=P3用户故事)

---

## Phase 1: Setup & Prerequisites

**目标**: 准备审计所需的工具和文档,建立审计方法

**验收标准**:
- ✅ 宪法文档已加载并理解
- ✅ 审计范围已明确界定
- ✅ 报告结构模板已准备

### Tasks

- [X] T001 读取并理解 `.specify/memory/constitution.md` 完整内容,特别关注五大原则和"历史代码处理"章节
- [X] T002 确认审计范围:列出需要审计的目录(internal/, cmd/, scripts/, migrations/),排除自动生成代码(models/)
- [X] T003 [P] 准备 TECH_DEBT.md 报告结构模板,按照 research.md 中定义的格式组织章节

---

## Phase 2: Foundational Research

**目标**: 完成静态分析和审计准备工作

**验收标准**:
- ✅ 静态分析工具已运行并输出结果
- ✅ 审计范围内的文件清单已生成
- ✅ 问题分类框架已建立

### Tasks

- [X] T004 [P] 运行 `golangci-lint run ./internal/... ./cmd/... --out-format=json > /tmp/golangci-report.json` 获取静态分析结果
- [X] T005 [P] 统计审计范围内的 Go 源文件数量,确保覆盖至少 80% 核心代码
- [X] T006 建立问题分类框架:创建五大宪法原则对应的问题类别(CQ, TD, UX, PF, OB)以及项目管理类别(MG, FC)

---

## Phase 3: User Story 1 - 审计代码质量问题 (P1)

**用户故事**: 作为开发团队成员,我需要了解现有代码库中哪些部分与新制定的项目宪法存在严重冲突,以便在未来的维护工作中有针对性地改进代码质量。

**独立测试标准**:
- ✅ TECH_DEBT.md 文件已生成,包含至少 20 个问题
- ✅ 每个问题都包含:问题描述、违反的宪法条款、文件路径和行号、改进建议
- ✅ 问题按照与宪法原则的冲突严重程度进行分类

**验收场景**:
1. Given 项目代码库存在多个与宪法原则冲突的代码片段, When 执行代码审计, Then 系统应生成 TECH_DEBT.md 文件,文件中包含所有识别出的主要问题
2. Given TECH_DEBT.md 文件已生成, When 开发人员查看文件内容, Then 每个问题都应包含清晰的问题描述、违反的宪法原则、具体的文件路径和行号
3. Given 代码库中存在不同严重程度的问题, When 审计完成, Then 问题应按照与宪法原则的冲突严重程度进行分类和排序

### Tasks

#### 审计代码质量原则 (CQ)

- [X] T007 [US1] 审计 `internal/` 目录,识别代码质量问题:缺失文档注释、不当的错误处理、命名不规范、潜在SQL注入风险
- [X] T008 [US1] 审计 `cmd/` 目录,识别应用入口点的代码质量问题
- [X] T009 [US1] 审计 `scripts/` 目录,识别部署脚本中的质量问题和安全风险

#### 审计测试驱动原则 (TD)

- [X] T010 [P] [US1] 审计 `internal/` 目录,识别缺失单元测试的核心业务逻辑
- [X] T011 [P] [US1] 检查 `tests/` 目录(如存在),评估测试覆盖率和测试质量

#### 审计用户体验原则 (UX)

- [X] T012 [P] [US1] 审计 `internal/api/` 或 `internal/handlers/` (如存在),识别API响应格式不一致、错误消息不清晰等问题

#### 审计性能原则 (PF)

- [X] T013 [P] [US1] 审计 `internal/` 目录,识别性能问题:N+1查询、缺失索引、goroutine泄漏、未优化的内存分配

#### 审计可观测性原则 (OB)

- [X] T014 [P] [US1] 审计 `internal/` 和 `cmd/` 目录,识别可观测性问题:缺失日志、错误无堆栈跟踪、缺失Prometheus指标

#### 审计数据库迁移 (MG)

- [X] T015 [P] [US1] 审计 `migrations/` 目录,识别迁移脚本问题:缺少回滚脚本、缺少注释、缺少事务包装、硬编码值

#### 审计项目文件组织 (FC)

- [X] T016 [P] [US1] 审计项目根目录,识别文件组织问题:多余文件(如QWEN.md)、缺失文档(如scripts/README.md)

#### 生成初步报告

- [X] T017 [US1] 汇总所有审计发现,按照 data-model.md 定义的 TechDebtItem 结构组织问题条目
- [X] T018 [US1] 为每个问题填写完整信息:issue_id、title、principle、severity、file_path、violated_clause、description、improvement_suggestion
- [X] T019 [US1] 将问题条目写入 TECH_DEBT.md,按照宪法原则分类组织章节
- [X] T020 [US1] 生成执行摘要:审计日期、审计范围、问题总数、按严重程度和原则的统计分布

---

## Phase 4: User Story 2 - 问题分类与优先级排序 (P2)

**用户故事**: 作为技术负责人,我需要看到技术债务按照宪法五大原则(代码质量、测试驱动、用户体验、性能、可观测性)进行分类,以便制定有针对性的改进计划。

**独立测试标准**:
- ✅ TECH_DEBT.md 文件结构清晰,有五大宪法原则对应的章节
- ✅ 每个宪法原则下至少有 3 个具体问题示例
- ✅ 报告包含问题摘要统计(每个原则下有多少问题)

**验收场景**:
1. Given 审计发现了多个代码质量问题, When 生成报告, Then 所有问题应按照五大宪法原则进行分类
2. Given 某个宪法原则下存在多个问题, When 查看该分类, Then 问题应按照严重程度排序(严重问题在前)
3. Given 报告生成完成, When 查看文件结构, Then 应包含问题摘要统计(每个原则下有多少问题)

### Tasks

- [X] T021 [US2] 检查问题数量:确保总数在 20-100 个之间,过滤掉次要问题或补充遗漏的严重问题
- [X] T022 [US2] 验证问题分布:确保每个宪法原则类别至少有 3 个问题示例
- [X] T023 [US2] 在每个原则章节内,按照严重程度排序问题(🔴严重 → 🟡中等 → 🟢轻微)
- [X] T024 [US2] 完善执行摘要:添加按原则分类的统计表格,突出显示问题最集中的领域
- [X] T025 [US2] 生成"关键发现"章节:从所有严重问题中提取 5-10 个最关键的发现

---

## Phase 5: User Story 3 - 生成可操作的改进建议 (P3)

**用户故事**: 作为开发人员,我希望对于每个识别出的问题,都能看到简要的改进方向建议,以便在触碰相关代码时知道如何应用"童子军军规"进行改进。

**独立测试标准**:
- ✅ TECH_DEBT.md 中每个问题都包含"改进建议"字段
- ✅ 改进建议具体可操作,包含清晰的步骤
- ✅ 每个问题类别开头提供通用的改进指导

**验收场景**:
1. Given 某个代码文件缺少测试覆盖, When 查看该问题记录, Then 应包含"添加单元测试"的改进建议
2. Given 某个函数缺少错误处理, When 查看该问题记录, Then 应包含"实现显式错误处理和日志记录"的建议
3. Given 多个问题有相似的改进方向, When 生成报告, Then 应在问题类别开头提供通用的改进指导

### Tasks

- [X] T026 [P] [US3] 审查所有问题条目的 `improvement_suggestion` 字段,确保每个建议都包含具体的改进步骤(至少 2-3 个步骤)
- [X] T027 [P] [US3] 为每个宪法原则章节添加"通用改进指导"段落,总结该原则下常见问题的共性改进方向
- [X] T028 [US3] 在 TECH_DEBT.md 开头添加"如何使用本报告"章节,说明如何应用"童子军军规"逐步改进代码
- [X] T029 [US3] 添加附录 C: "改进优先级建议",基于严重程度和影响范围提供改进路线图

---

## Phase 6: Polish & Cross-Cutting Concerns

**目标**: 完善报告质量,确保符合所有成功标准

**验收标准**:
- ✅ 报告生成时间 <10 分钟
- ✅ 技术负责人审阅报告后,能在 30 分钟内理解技术债务整体状况
- ✅ 所有问题记录都包含准确的文件路径引用
- ✅ 报告明确标注这是历史代码审计,不代表立即修复要求

### Tasks

- [X] T030 验证所有文件路径引用的准确性:确保每个 `file_path` 指向实际存在的文件
- [X] T031 检查报告完整性:确保包含所有必需章节(执行摘要、五大原则分类、附录)
- [X] T032 添加历史代码审计声明:在报告开头明确标注这是历史代码审计,不代表立即修复要求,符合宪法"历史代码处理"原则
- [X] T033 生成附录 A: "审计方法说明",解释混合式审计方法(静态分析 + 人工审查)
- [X] T034 生成附录 B: "问题严重程度定义",详细说明严重、中等、轻微的判定标准
- [X] T035 校对报告:检查拼写、格式一致性、Markdown 语法正确性
- [X] T036 最终验证:确认问题总数在 20-100 之间,每个原则至少 3 个示例,覆盖至少 80% 核心代码

---

## Dependencies & Execution Order

### User Story Dependencies

```
Phase 1 (Setup) ──────────┐
                           │
Phase 2 (Foundational) ────┤
                           │
                           ├──> Phase 3 (US1 - P1) ──> Phase 4 (US2 - P2) ──> Phase 5 (US3 - P3) ──> Phase 6 (Polish)
```

**说明**:
- Phase 1 和 Phase 2 是所有用户故事的前置条件,必须先完成
- Phase 3 (US1) 必须完成后才能进行 Phase 4 (US2),因为优先级排序依赖于问题的完整识别
- Phase 4 (US2) 必须完成后才能进行 Phase 5 (US3),因为改进建议需要基于分类和优先级
- Phase 5 (US3) 完成后进入 Phase 6 最终打磨

### Task-Level Dependencies

**严格顺序**:
- T001-T003 (Setup) → T004-T006 (Foundational) → T007-T016 (US1 审计) → T017-T020 (US1 生成报告)
- T020 完成后 → T021-T025 (US2 分类排序)
- T025 完成后 → T026-T029 (US3 改进建议)
- T029 完成后 → T030-T036 (Polish)

**可并行执行的任务组**:
- T007, T008, T009 (代码质量审计 - 不同目录)
- T010, T011 (测试驱动审计 - 不同方面)
- T012, T013, T014, T015, T016 (其他原则审计 - 独立原则)
- T026, T027 (改进建议完善 - 不同层面)

---

## Parallel Execution Examples

### Phase 3 (US1) - 并行审计

可以同时执行以下审计任务,因为它们审查不同的原则或不同的目录:

```bash
# 并行执行组 1: 不同原则的审计
Task T010 (测试驱动)  ║
Task T012 (用户体验)  ║  同时进行
Task T013 (性能)      ║
Task T014 (可观测性)  ║
Task T015 (数据库迁移)║
Task T016 (文件组织)  ║

# 并行执行组 2: 不同目录的代码质量审计
Task T007 (internal/) ║
Task T008 (cmd/)      ║  同时进行
Task T009 (scripts/)  ║
```

**预计时间节省**: 通过并行执行,Phase 3 可从 ~15 分钟缩短至 ~6 分钟

### Phase 5 (US3) - 并行改进建议

```bash
Task T026 (完善单个问题建议) ║  同时进行
Task T027 (添加通用指导)     ║
```

---

## Implementation Strategy

### MVP Scope (最小可行产品)

**目标**: 快速交付基本可用的技术债务报告

**包含**:
- Phase 1: Setup
- Phase 2: Foundational
- Phase 3: User Story 1 (P1) - 完整的审计和初步报告

**验收标准**:
- ✅ TECH_DEBT.md 已生成,包含至少 20 个问题
- ✅ 问题按宪法原则分类
- ✅ 每个问题都有基本的描述和文件路径

**预计完成时间**: ~8 分钟(符合 <10 分钟的性能目标)

### Incremental Delivery

**迭代 1** (MVP):
- 完成 Phase 1-3
- 交付基本的技术债务报告

**迭代 2** (优先级排序):
- 完成 Phase 4 (US2)
- 提供分类统计和优先级排序

**迭代 3** (改进指导):
- 完成 Phase 5 (US3)
- 添加可操作的改进建议

**迭代 4** (打磨):
- 完成 Phase 6
- 最终质量保证和验证

---

## Quality Gates

每个阶段完成后必须通过以下质量门:

### Phase 3 (US1) Gate

- [ ] 问题总数 >= 20
- [ ] 所有问题都有 file_path 和 description
- [ ] 至少 70% 的问题有 code_snippet

### Phase 4 (US2) Gate

- [ ] 每个宪法原则至少 3 个问题
- [ ] 问题总数在 20-100 之间
- [ ] 问题按严重程度排序

### Phase 5 (US3) Gate

- [ ] 100% 的问题都有 improvement_suggestion
- [ ] 每个原则章节都有通用改进指导
- [ ] 附录 C 已生成

### Phase 6 (Polish) Gate

- [ ] 所有文件路径已验证
- [ ] 报告包含所有必需章节
- [ ] 历史代码审计声明已添加
- [ ] 技术负责人能在 30 分钟内理解报告

---

## Task Summary

**总任务数**: 36

**任务分布**:
- Phase 1 (Setup): 3 tasks
- Phase 2 (Foundational): 3 tasks
- Phase 3 (US1 - P1): 14 tasks
- Phase 4 (US2 - P2): 5 tasks
- Phase 5 (US3 - P3): 4 tasks
- Phase 6 (Polish): 7 tasks

**并行任务数**: 11 tasks (标记为 [P])

**预计总时间**:
- 串行执行: ~25 分钟
- 并行执行: ~10 分钟 (符合性能目标)

---

## Notes

1. **无需编程**: 本项目是文档生成任务,所有任务都是人工代码审查和 Markdown 文档编写,无需编写或运行代码
2. **无需测试**: 作为一次性审计活动,无需编写自动化测试
3. **聚焦范围**: 根据用户要求,本项目完全不考虑前端和战斗系统,审计聚焦于后端核心业务逻辑、认证、通用组件和基础设施代码
4. **宪法遵循**: 严格遵循"历史代码处理"原则:只记录问题,不主动修复
5. **可重复执行**: 建议每季度重新运行此审计流程,跟踪技术债务的改善情况

---

**最后更新**: 2025-10-21
**维护者**: TSU 开发团队
