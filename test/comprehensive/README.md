# TSU Admin API å…¨é¢æµ‹è¯•æ¡†æ¶

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå…¨é¢ã€æ¨¡å—åŒ–çš„ Admin æœåŠ¡æ¥å£æµ‹è¯•æ¡†æ¶ï¼Œè¦†ç›– 110+ ä¸ªæ¥å£ï¼ŒåŒ…å«å®Œæ•´çš„ CRUD æµ‹è¯•ã€æ•°æ®éªŒè¯ã€å…³è”å…³ç³»æµ‹è¯•å’Œè¾¹ç•Œæ¡ä»¶æµ‹è¯•ã€‚

## ğŸ—ï¸ æ¶æ„

```
test/comprehensive/
â”œâ”€â”€ main_test.sh              # ä¸»æµ‹è¯•å…¥å£
â”œâ”€â”€ lib/                      # æµ‹è¯•æ¡†æ¶åº“
â”‚   â”œâ”€â”€ test_framework.sh     # HTTPå°è£…ã€æ–­è¨€ã€æŠ¥å‘Š
â”‚   â”œâ”€â”€ test_data.sh          # æµ‹è¯•æ•°æ®åˆ›å»ºå’Œæ¸…ç†
â”‚   â””â”€â”€ test_utils.sh         # å·¥å…·å‡½æ•°
â”œâ”€â”€ suites/                   # æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ 01_system_health.sh   # ç³»ç»Ÿå¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ 02_authentication.sh  # è®¤è¯æµç¨‹
â”‚   â”œâ”€â”€ 03_user_management.sh # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ 04_rbac_system.sh     # æƒé™ç³»ç»Ÿ
â”‚   â”œâ”€â”€ 05_game_config_basic.sh # åŸºç¡€æ¸¸æˆé…ç½®
â”‚   â”œâ”€â”€ 06_metadata.sh        # å…ƒæ•°æ®å®šä¹‰
â”‚   â”œâ”€â”€ 07_skill_system.sh    # æŠ€èƒ½ç³»ç»Ÿ
â”‚   â”œâ”€â”€ 08_effect_system.sh   # æ•ˆæœç³»ç»Ÿ
â”‚   â”œâ”€â”€ 09_action_system.sh   # åŠ¨ä½œç³»ç»Ÿ
â”‚   â”œâ”€â”€ 10_relations.sh       # å…³è”å…³ç³»
â”‚   â””â”€â”€ 11_edge_cases.sh      # è¾¹ç•Œæ¡ä»¶
â””â”€â”€ reports/                  # æµ‹è¯•æŠ¥å‘Šè¾“å‡ºç›®å½•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- `curl` - HTTP è¯·æ±‚å·¥å…·
- `jq` - JSON å¤„ç†å·¥å…·
- Admin æœåŠ¡è¿è¡Œåœ¨ `http://localhost:80`
- æµ‹è¯•è´¦æˆ·: `root` / `password`

### å®‰è£…ä¾èµ–

```bash
# macOS
brew install curl jq

# Ubuntu/Debian
apt-get install curl jq

# CentOS/RHEL
yum install curl jq
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd /Users/lonyon/working/å†›ä¿¡ä¸œæ–¹/tsué¡¹ç›®/tsu-server-self/tsu-self/test/comprehensive
./main_test.sh
```

### è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶

```bash
# åªè¿è¡ŒæŠ€èƒ½ç³»ç»Ÿæµ‹è¯•
./main_test.sh --suite 07

# åªè¿è¡Œè®¤è¯æµ‹è¯•
./main_test.sh --suite 02
```

### è‡ªå®šä¹‰é…ç½®

```bash
# ä½¿ç”¨è‡ªå®šä¹‰ API åœ°å€å’Œè´¦å·
./main_test.sh \
  --url http://test.example.com \
  --username admin \
  --password admin123

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
./main_test.sh --verbose

# æµ‹è¯•åä¸æ¸…ç†æ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
./main_test.sh --no-cleanup
```

## ğŸ“Š æµ‹è¯•è¦†ç›–

### æµ‹è¯•å¥—ä»¶åˆ—è¡¨

| å¥—ä»¶ | åç§° | æ¥å£æ•° | è¯´æ˜ |
|-----|------|-------|------|
| 01 | ç³»ç»Ÿå¥åº·æ£€æŸ¥ | 3 | å¥åº·æ£€æŸ¥ã€Swaggerã€API è·¯å¾„éªŒè¯ |
| 02 | è®¤è¯æµç¨‹ | 6 | ç™»å½•ã€ç™»å‡ºã€Token éªŒè¯ã€é”™è¯¯åœºæ™¯ |
| 03 | ç”¨æˆ·ç®¡ç† | 7 | ç”¨æˆ· CRUDã€æœç´¢ã€åˆ†é¡µã€é”™è¯¯å¤„ç† |
| 04 | RBAC æƒé™ç³»ç»Ÿ | 14 | è§’è‰²ã€æƒé™ã€ç”¨æˆ·-è§’è‰²å…³è” |
| 05 | åŸºç¡€æ¸¸æˆé…ç½® | 24+ | èŒä¸šã€æŠ€èƒ½åˆ†ç±»ã€ä¼¤å®³ç±»å‹ã€å±æ€§ç±»å‹ã€æ ‡ç­¾ã€åŠ¨ä½œæ ‡è®° |
| 06 | å…ƒæ•°æ®å®šä¹‰ | 12 | æ•ˆæœç±»å‹ã€å…¬å¼å˜é‡ã€èŒƒå›´è§„åˆ™ã€åŠ¨ä½œç±»å‹ï¼ˆåªè¯»ï¼‰ |
| 07 | æŠ€èƒ½ç³»ç»Ÿ | 10+ | æŠ€èƒ½ CRUDã€å‡çº§æ¶ˆè€—ã€è§£é”åŠ¨ä½œ |
| 08 | æ•ˆæœç³»ç»Ÿ | 15+ | æ•ˆæœã€Buffã€Buff-Effects å…³è” |
| 09 | åŠ¨ä½œç³»ç»Ÿ | 15+ | åŠ¨ä½œ CRUDã€Action-Effectsã€Skill-Unlock-Actions |
| 10 | å…³è”å…³ç³» | 10+ | æ ‡ç­¾å…³è”ã€èŒä¸šå±æ€§åŠ æˆã€èŒä¸šè¿›é˜¶ |
| 11 | è¾¹ç•Œæ¡ä»¶ | 20+ | 404ã€400ã€401ã€åˆ†é¡µè¾¹ç•Œã€ç‰¹æ®Šå­—ç¬¦ã€æ€§èƒ½ |

**æ€»è®¡**: 110+ ä¸ªæ¥å£æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç±»å‹

- âœ… **åŠŸèƒ½æµ‹è¯•**: æ‰€æœ‰ CRUD æ“ä½œ
- âœ… **æ•°æ®éªŒè¯**: å­—æ®µå­˜åœ¨æ€§ã€ç±»å‹æ­£ç¡®æ€§
- âœ… **å…³è”å…³ç³»**: å¤šå¯¹å¤šã€ä¸€å¯¹å¤šå…³è”
- âœ… **é”™è¯¯å¤„ç†**: 404ã€400ã€401ã€403
- âœ… **è¾¹ç•Œæ¡ä»¶**: åˆ†é¡µã€ç‰¹æ®Šå­—ç¬¦ã€å¹¶å‘
- âœ… **æ€§èƒ½ç›‘æ§**: å“åº”æ—¶é—´è®°å½•

## ğŸ“ æµ‹è¯•æŠ¥å‘Š

### æŠ¥å‘Šæ–‡ä»¶

æµ‹è¯•å®Œæˆåï¼ŒæŠ¥å‘Šä¿å­˜åœ¨ `reports/run_YYYYMMDD_HHMMSS/` ç›®å½•ï¼š

```
reports/run_20250106_143022/
â”œâ”€â”€ summary.log         # æµ‹è¯•æ‘˜è¦
â”œâ”€â”€ detailed.log        # è¯¦ç»†æµ‹è¯•æ—¥å¿—
â”œâ”€â”€ api_calls.log       # æ‰€æœ‰ API è°ƒç”¨è®°å½•
â”œâ”€â”€ failures.log        # å¤±è´¥ç”¨ä¾‹è¯¦æƒ…
â””â”€â”€ test_data.json      # æµ‹è¯•æ•°æ®å¿«ç…§
```

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     TSU Admin API å…¨é¢æµ‹è¯•æ¡†æ¶     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

========================================
æµ‹è¯•å¥—ä»¶: æŠ€èƒ½ç³»ç»Ÿ
========================================
âœ“ [01] è·å–æŠ€èƒ½åˆ—è¡¨ - 200 OK (123ms)
âœ“ [02] åˆ›å»ºæµ‹è¯•æŠ€èƒ½ - 201 Created (156ms)
âœ“ [03] è·å–æŠ€èƒ½è¯¦æƒ… - 200 OK (45ms)
âœ— [04] æ›´æ–°æŠ€èƒ½ - 500 Internal Error (234ms)
  Response: {"error":"internal server error"}

----------------------------------------
å¥—ä»¶: æŠ€èƒ½ç³»ç»Ÿ
æ€»è®¡: 4 ä¸ªæµ‹è¯•
é€šè¿‡: 3
å¤±è´¥: 1
ç”¨æ—¶: 558ms
----------------------------------------

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           æµ‹è¯•æ€»ç»“æŠ¥å‘Š             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ€»æµ‹è¯•æ•°:   110
é€šè¿‡:       108
å¤±è´¥:       2
é€šè¿‡ç‡:     98%

âœ… æµ‹è¯•å®Œæˆï¼
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### åªæµ‹è¯•ç‰¹å®šæ¨¡å—

```bash
# åªæµ‹è¯•è®¤è¯å’Œç”¨æˆ·ç®¡ç†
./main_test.sh --suite "02|03"

# åªæµ‹è¯•æ¸¸æˆé…ç½®ç›¸å…³
./main_test.sh --suite "05|06|07|08|09"
```

### è°ƒè¯•æ¨¡å¼

```bash
# è¯¦ç»†è¾“å‡º + ä¸æ¸…ç†æ•°æ®
./main_test.sh --verbose --no-cleanup

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
tail -f reports/run_*/detailed.log

# æŸ¥çœ‹ API è°ƒç”¨
cat reports/run_*/api_calls.log
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡
export BASE_URL="http://localhost:80"
export USERNAME="root"
export PASSWORD="password"

./main_test.sh
```

## ğŸ¯ æµ‹è¯•ç­–ç•¥

### æ•°æ®éš”ç¦»

- æ‰€æœ‰æµ‹è¯•æ•°æ®å¸¦ `[TEST-timestamp]` å‰ç¼€
- æ¯æ¬¡è¿è¡Œä½¿ç”¨å”¯ä¸€æ—¶é—´æˆ³
- æµ‹è¯•ç»“æŸè‡ªåŠ¨æ¸…ç†ï¼ˆå¯é€‰å…³é—­ï¼‰

### ä¾èµ–ç®¡ç†

æµ‹è¯•æŒ‰ä¾èµ–é¡ºåºæ‰§è¡Œï¼š

1. **åŸºç¡€è®¾æ–½**: ç³»ç»Ÿå¥åº· â†’ è®¤è¯
2. **ç”¨æˆ·æƒé™**: ç”¨æˆ·ç®¡ç† â†’ RBAC
3. **æ¸¸æˆåŸºç¡€**: èŒä¸šã€åˆ†ç±»ã€ç±»å‹ â†’ å…ƒæ•°æ®
4. **æ ¸å¿ƒç³»ç»Ÿ**: æŠ€èƒ½ â†’ æ•ˆæœ â†’ åŠ¨ä½œ
5. **å…³è”å…³ç³»**: æ ‡ç­¾ã€å±æ€§ã€è¿›é˜¶
6. **è¾¹ç•Œæµ‹è¯•**: é”™è¯¯å¤„ç†ã€æ€§èƒ½

### é”™è¯¯å¤„ç†

- é»˜è®¤å¤±è´¥åç»§ç»­æ‰§è¡Œ (`--continue-on-failure`)
- è‡ªåŠ¨é‡è¯•ç½‘ç»œè¯·æ±‚ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯

## ğŸ“š æ‰©å±•å¼€å‘

### æ·»åŠ æ–°æµ‹è¯•å¥—ä»¶

1. åœ¨ `suites/` ç›®å½•åˆ›å»ºæ–°æ–‡ä»¶ï¼š

```bash
cp suites/01_system_health.sh suites/12_new_feature.sh
```

2. ä¿®æ”¹æµ‹è¯•å‡½æ•°ï¼š

```bash
test_new_feature() {
    start_test_suite "æ–°åŠŸèƒ½æµ‹è¯•"
    
    test_case "æµ‹è¯•ç”¨ä¾‹æè¿°"
    http_request "GET" "/api/v1/endpoint" "" true
    assert_success "æµ‹è¯•ç”¨ä¾‹æˆåŠŸ"
    
    end_test_suite
}
```

3. åœ¨ `main_test.sh` ä¸­æ³¨å†Œå¥—ä»¶ï¼š

```bash
local suites=(
    # ... ç°æœ‰å¥—ä»¶
    "12_new_feature:test_new_feature"
)
```

### è‡ªå®šä¹‰æ–­è¨€

åœ¨ `lib/test_utils.sh` ä¸­æ·»åŠ è‡ªå®šä¹‰æ–­è¨€å‡½æ•°ï¼š

```bash
assert_custom() {
    local condition="$1"
    local description="$2"
    
    if [ "$condition" = "true" ]; then
        log_success "$description"
        return 0
    else
        log_error "$description"
        return 1
    fi
}
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. Token æ— æ³•è·å–

**ç—‡çŠ¶**: ç™»å½•åæå–ä¸åˆ° Token

**è§£å†³**:
- æ£€æŸ¥ API å“åº”æ ¼å¼
- æŸ¥çœ‹ `api_calls.log` ä¸­çš„ç™»å½•å“åº”
- ç¡®è®¤å­—æ®µè·¯å¾„ `.data.session_token` æˆ– `.data.token`

### 2. è¿æ¥è¢«æ‹’ç»

**ç—‡çŠ¶**: `Connection refused` é”™è¯¯

**è§£å†³**:
- ç¡®è®¤æœåŠ¡è¿è¡Œ: `curl http://localhost:80/health`
- æ£€æŸ¥ Docker å®¹å™¨: `docker ps | grep tsu`
- æŸ¥çœ‹ Nginx é…ç½®

### 3. æƒé™ä¸è¶³

**ç—‡çŠ¶**: å¤§é‡ 403 é”™è¯¯

**è§£å†³**:
- ç¡®è®¤ä½¿ç”¨ root è´¦æˆ·
- æ£€æŸ¥è§’è‰²æƒé™é…ç½®
- æŸ¥çœ‹ Kratos/Keto æœåŠ¡çŠ¶æ€

### 4. æµ‹è¯•æ•°æ®æœªæ¸…ç†

**ç—‡çŠ¶**: æ•°æ®åº“æ®‹ç•™ `[TEST]` æ•°æ®

**è§£å†³**:
```bash
# æ‰‹åŠ¨æ¸…ç†
psql -d tsu_db -c "DELETE FROM game_config.classes WHERE name LIKE '[TEST%';"

# æˆ–ä½¿ç”¨æ ‡è®°
./main_test.sh --no-cleanup  # ä¿ç•™æ•°æ®ç”¨äºè°ƒè¯•
```

## ğŸ“ æ”¯æŒ

- **æ–‡æ¡£**: `/docs/API_TESTING.md`
- **é—®é¢˜åé¦ˆ**: é¡¹ç›® Issue Tracker
- **æµ‹è¯•è®¡åˆ’**: `/test/comprehensive/plan.md`

## ğŸ“„ è®¸å¯è¯

ä¸ TSU é¡¹ç›®ä¸»ä½“ä¿æŒä¸€è‡´
