<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TSU API æ–‡æ¡£ - è°ƒè¯•ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui.css" />
    <style>
        .debug-panel {
            position: fixed;
            top: 60px;
            right: 10px;
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            max-width: 350px;
            max-height: 500px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        .debug-panel h4 {
            margin: 0 0 10px 0;
            color: #3498db;
            font-size: 14px;
        }
        .debug-log {
            max-height: 400px;
            overflow-y: auto;
            background: #34495e;
            padding: 8px;
            border-radius: 4px;
        }
        .debug-log div {
            margin: 3px 0;
            padding: 4px;
            border-left: 3px solid transparent;
            font-size: 10px;
            line-height: 1.4;
        }
        .success { border-left-color: #27ae60; color: #2ecc71; }
        .error { border-left-color: #c0392b; color: #e74c3c; }
        .warning { border-left-color: #f39c12; color: #f1c40f; }
        .info { border-left-color: #3498db; color: #5dade2; }
        .debug-panel button {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-bottom: 10px;
        }
        .debug-panel button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div id="swagger-ui"></div>
    
    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel">
        <h4>ğŸ” è®¤è¯è°ƒè¯•æ—¥å¿—</h4>
        <button onclick="document.getElementById('debug-log').innerHTML = ''">æ¸…é™¤æ—¥å¿—</button>
        <div id="debug-log" class="debug-log"></div>
    </div>

    <script src="https://unpkg.com/swagger-ui-dist@4.15.5/swagger-ui-bundle.js" crossorigin></script>
    <script>
        function debugLog(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG ${time}] [${type.toUpperCase()}]`, message);
        }

        window.onload = () => {
            const apiDocUrl = window.location.protocol + '//' + window.location.host + '/swagger/admin/doc.json';
            debugLog('ğŸš€ åŠ è½½ Swagger: ' + apiDocUrl, 'info');
            
            window.ui = SwaggerUIBundle({
                url: apiDocUrl,
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIBundle.presets.standalone,
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                docExpansion: "list",
                showRequestHeaders: true,
                showCommonExtensions: true,
                persistAuthorization: true,
                
                // ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨æ·»åŠ  Bearer å‰ç¼€
                requestInterceptor: (request) => {
                    const url = new URL(request.url);
                    debugLog('ğŸ“¤ è¯·æ±‚: ' + request.method + ' ' + url.pathname, 'info');
                    
                    if (request.headers) {
                        if (request.headers.Authorization) {
                            let auth = request.headers.Authorization;
                            debugLog('åŸå§‹ Auth: ' + auth.substring(0, 20) + '...', 'warning');
                            
                            // è‡ªåŠ¨æ·»åŠ  Bearer å‰ç¼€
                            if (!auth.startsWith('Bearer ') && !auth.startsWith('bearer ')) {
                                auth = 'Bearer ' + auth.trim();
                                request.headers.Authorization = auth;
                                debugLog('âœ… å·²æ·»åŠ  Bearer å‰ç¼€', 'success');
                            }
                            
                            debugLog('æœ€ç»ˆ Auth: Bearer ' + auth.substring(7, 27) + '...', 'success');
                        } else {
                            debugLog('âš ï¸  æœªæˆæƒï¼è¯·ç‚¹å‡» Authorize æŒ‰é’®', 'error');
                        }
                    }
                    
                    return request;
                },
                
                responseInterceptor: (response) => {
                    if (response.status >= 200 && response.status < 300) {
                        debugLog('âœ… æˆåŠŸ: ' + response.status, 'success');
                    } else if (response.status === 401) {
                        debugLog('âŒ 401 æœªæˆæƒ - Token æ— æ•ˆæˆ–è¿‡æœŸ', 'error');
                    } else if (response.status === 403) {
                        debugLog('âŒ 403 ç¦æ­¢è®¿é—® - æƒé™ä¸è¶³', 'error');
                    } else {
                        debugLog('âš ï¸  å“åº”: ' + response.status + ' ' + response.statusText, 'warning');
                    }
                    return response;
                },
                
                onComplete: function() {
                    debugLog('âœ… Swagger UI åŠ è½½å®Œæˆ', 'success');
                    
                    // ç›‘å¬æˆæƒçŠ¶æ€
                    setTimeout(() => {
                        const authBtn = document.querySelector('.btn.authorize');
                        if (authBtn) {
                            authBtn.addEventListener('click', () => {
                                debugLog('ğŸ‘† ç‚¹å‡»äº† Authorize æŒ‰é’®', 'info');
                            });
                            
                            const isLocked = authBtn.classList.contains('locked');
                            if (isLocked) {
                                debugLog('ğŸ”’ å½“å‰çŠ¶æ€: å·²æˆæƒ', 'success');
                            } else {
                                debugLog('ğŸ”“ å½“å‰çŠ¶æ€: æœªæˆæƒ', 'warning');
                            }
                        }
                    }, 1500);
                    
                    // æ·»åŠ é†’ç›®çš„ä½¿ç”¨æŒ‡å—
                    setTimeout(() => {
                        const infoContainer = document.querySelector('.info');
                        if (infoContainer && !document.querySelector('#auth-guide')) {
                            const guide = document.createElement('div');
                            guide.id = 'auth-guide';
                            guide.innerHTML = `
                                <div style="margin: 20px 0; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);">
                                    <h2 style="margin: 0 0 20px 0; color: white; font-size: 24px;">ğŸ” è®¤è¯é…ç½®æ­¥éª¤</h2>
                                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                        <h3 style="margin: 0 0 15px 0; color: #ffd700; font-size: 18px;">æ“ä½œæ­¥éª¤ï¼š</h3>
                                        <ol style="margin: 0; padding-left: 25px; line-height: 2; font-size: 15px;">
                                            <li><strong style="color: #ffd700;">æ‰¾åˆ°é¡µé¢å³ä¸Šè§’çš„ "Authorize" ğŸ”“ æŒ‰é’®å¹¶ç‚¹å‡»</strong></li>
                                            <li><strong style="color: #ffd700;">åœ¨å¼¹å‡ºæ¡†çš„ "Value" è¾“å…¥æ¡†ä¸­ç²˜è´´ä½ çš„ session token</strong><br>
                                                <span style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-family: monospace; display: inline-block; margin-top: 5px;">ä¾‹å¦‚: ory_st_xxxxxxxxxxxxxx</span></li>
                                            <li><strong style="color: #ffd700;">ç‚¹å‡»ç»¿è‰²çš„ "Authorize" æŒ‰é’®ç¡®è®¤</strong></li>
                                            <li><strong style="color: #ffd700;">ç‚¹å‡» "Close" å…³é—­å¼¹æ¡†</strong></li>
                                            <li><strong style="color: #ffd700;">ç°åœ¨å¯ä»¥æµ‹è¯•APIäº†ï¼å³ä¾§ä¼šæ˜¾ç¤ºè¯·æ±‚æ—¥å¿—</strong></li>
                                        </ol>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; border: 2px dashed rgba(255,255,255,0.3);">
                                        <p style="margin: 0 0 10px 0; font-size: 14px; line-height: 1.6;">
                                            ğŸ’¡ <strong>é‡è¦æç¤ºï¼š</strong><br>
                                            â€¢ ä¸éœ€è¦æ‰‹åŠ¨è¾“å…¥ "Bearer " å‰ç¼€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ <br>
                                            â€¢ æŸ¥çœ‹å³ä¸Šè§’çš„<strong>è°ƒè¯•é¢æ¿</strong>ï¼Œå¯ä»¥å®æ—¶çœ‹åˆ°æ¯æ¬¡è¯·æ±‚çš„è®¤è¯ä¿¡æ¯<br>
                                            â€¢ å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ token æ˜¯å¦æ­£ç¡®æˆ–æ˜¯å¦å·²è¿‡æœŸ<br>
                                            â€¢ Token å¯ä»¥é€šè¿‡ç™»å½•æ¥å£è·å–: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">/auth/login</code>
                                        </p>
                                    </div>
                                </div>
                            `;
                            infoContainer.appendChild(guide);
                            debugLog('ğŸ“ ä½¿ç”¨æŒ‡å—å·²åŠ è½½', 'success');
                        }
                    }, 1000);
                }
            });
        };
    </script>
</body>
</html>
