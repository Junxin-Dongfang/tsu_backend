<!doctype html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>用户站点</title>
  <style>
    body{font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0}
    .wrap{max-width: 720px; margin: 5vh auto; padding: 24px}
    .card{background:#111827;border:1px solid #334155;border-radius:12px;padding:20px}
    h1{margin:0 0 12px;font-size:24px}
    input,button{padding:10px 12px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e2e8f0}
    button{background:#2563eb;border-color:#2563eb;cursor:pointer}
    .row{display:flex;gap:8px;margin:8px 0}
    .muted{color:#94a3b8;font-size:12px}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:12px}
    a{color:#60a5fa}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>用户站点</h1>
    <div class="muted">接口通过 http 网关 8090 反代到 auth 模块(8091)。</div>
    <div class="row">
      <input id="identifier" placeholder="用户名或邮箱" />
      <input id="password" placeholder="密码" type="password" />
      <button onclick="login()">登录</button>
    </div>
    <div class="row">
      <input id="reg_username" placeholder="注册用户名" />
      <input id="reg_email" placeholder="注册邮箱" />
      <input id="reg_password" placeholder="注册密码" type="password" />
      <button onclick="registerUser()">注册</button>
    </div>
    <div class="row">
      <button onclick="getProfile()">获取我的信息</button>
      <button onclick="logout()">退出登录</button>
      <button onclick="gotoAdmin()">去管理站点(SSO)</button>
    </div>
    <pre id="out">未操作</pre>
  </div>
</div>
<script>
  const api = (p)=>`/auth${p}`; // 通过 8090 的 /auth/* 反代到 8091
  // 子域切换工具：将当前主机名的首段替换为目标子域
  function subHost(target){
    const parts = location.hostname.split('.');
    if(parts.length>=2){ parts[0] = target; return parts.join('.'); }
    return target + '.tsu.test';
  }
  async function login(){
    const body={identifier:document.getElementById('identifier').value,password:document.getElementById('password').value};
    const r=await fetch(api('/login'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),credentials:'include'});
    const j=await r.json();
    if(j?.data?.session_token){
      // 便于非浏览器API携带，会话也保存在 cookie: ory_kratos_session
      localStorage.setItem('session_token', j.data.session_token);
    }
    show(j);
  }
  async function registerUser(){
    const body={username:document.getElementById('reg_username').value,email:document.getElementById('reg_email').value,password:document.getElementById('reg_password').value};
    const r=await fetch(api('/register'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),credentials:'include'});
    show(await r.json());
  }
  async function getProfile(){
    const token = localStorage.getItem('session_token');
    const r=await fetch(api('/profile'),{headers:{'Authorization': token?`Bearer ${token}`:''},credentials:'include'});
    show(await r.json());
  }
  async function logout(){
    const token = localStorage.getItem('session_token');
    const r=await fetch(api('/logout'),{method:'POST',headers:{'Authorization': token?`Bearer ${token}`:''},credentials:'include'});
    localStorage.removeItem('session_token');
    show(await r.json());
  }
  async function gotoAdmin(){
    // 跳转到 admin 子域根（由 Nginx 自动重定向到 /site-admin/）
    const host = subHost('admin');
    location.href = `${location.protocol}//${host}/`;
  }
  function show(j){
    document.getElementById('out').textContent=JSON.stringify(j,null,2);
  }
</script>
</body>
</html>
